generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  updatedAt         DateTime @default(now()) @updatedAt
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@index([updatedAt])
}

model AccountingAlert {
  id         String    @id @default(cuid())
  type       String
  severity   String    @default("MEDIUM")
  title      String
  message    String
  entityType String?
  entityId   String?
  link       String?
  readAt     DateTime?
  readBy     String?
  resolvedAt DateTime?
  resolvedBy String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([createdAt])
  @@index([readAt])
  @@index([severity])
  @@index([type])
  @@index([updatedAt])
}

// TODO #51: Create AuditTrail model to store structured audit entries instead of console.info logs.
//   Fields: id, action (CREATE/UPDATE/DELETE/VOID/POST), entityType, entityId,
//   userId, previousValues (Json?), newValues (Json?), ipAddress, createdAt
//   This replaces scattered console.info audit logs with queryable DB records.

// TODO #52: Create RecurringEntryTemplate model to persist recurring templates in DB.
//   Fields: id, name, description, frequency (DAILY/WEEKLY/MONTHLY/QUARTERLY/YEARLY),
//   dayOfMonth, dayOfWeek, monthOfYear, lines (Json), startDate, endDate,
//   nextRunDate, isActive, autoPost, notifyOnCreate, createdBy, createdAt, updatedAt

model AccountingPeriod {
  id               String    @id @default(cuid())
  name             String
  code             String    @unique
  startDate        DateTime
  endDate          DateTime
  status           String    @default("OPEN")
  closedAt         DateTime?
  closedBy         String?
  closingChecklist String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([startDate])
  @@index([status])
  @@index([createdAt])
  @@index([updatedAt])
}

model FiscalYear {
  id        String    @id @default(cuid())
  name      String
  startDate DateTime
  endDate   DateTime
  isClosed  Boolean   @default(false)
  closedAt  DateTime?
  closedBy  String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([startDate])
  @@index([isClosed])
  @@index([createdAt])
  @@index([updatedAt])
}

model AccountingSettings {
  id                    String  @id @default("default")
  companyName           String  @default("BioCycle Peptides Inc.")
  companyAddress        String?
  companyCity           String  @default("Montréal")
  companyProvince       String  @default("QC")
  companyPostalCode     String?
  companyPhone          String?
  companyEmail          String?
  tpsNumber             String?
  tvqNumber             String?
  neq                   String?
  fiscalYearStart       Int     @default(1)
  accountingMethod      String  @default("ACCRUAL")
  defaultCurrency       String  @default("CAD")
  taxFilingFrequency    String  @default("MONTHLY")
  autoCreateSaleEntries Boolean @default(true)
  autoReconcileStripe   Boolean @default(true)

  // Quick Method GST/HST (méthode rapide)
  quickMethodEnabled  Boolean @default(false)
  quickMethodProvince String  @default("QC")

  // Document Retention Policy
  blockDeletionDuringRetention Boolean @default(true)

  updatedAt DateTime @updatedAt
  @@index([updatedAt])
}

model Ambassador {
  id             String                 @id @default(cuid())
  userId         String?
  name           String
  email          String?                @unique
  phone          String?
  referralCode   String                 @unique
  commissionRate Decimal                @default(10) @db.Decimal(5, 2)
  totalReferrals Int                    @default(0)
  totalEarnings  Decimal                @default(0) @db.Decimal(12, 2)
  status         String                 @default("ACTIVE")
  tier           String                 @default("BRONZE")
  joinedAt       DateTime               @default(now())
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
  user           User?                  @relation(fields: [userId], references: [id])
  commissions    AmbassadorCommission[]
  payouts        AmbassadorPayout[]

  @@index([referralCode])
  @@index([status])
  @@index([userId])
  @@index([createdAt])
  @@index([updatedAt])
}

model AmbassadorCommission {
  id               String            @id @default(cuid())
  ambassadorId     String
  orderId          String
  orderNumber      String
  orderTotal       Decimal           @db.Decimal(10, 2)
  commissionRate   Decimal           @db.Decimal(5, 2)
  commissionAmount Decimal           @db.Decimal(10, 2)
  paidOut          Boolean           @default(false)
  paidOutAt        DateTime?
  payoutId         String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  ambassador       Ambassador        @relation(fields: [ambassadorId], references: [id], onDelete: Cascade)
  payout           AmbassadorPayout? @relation(fields: [payoutId], references: [id])

  @@unique([ambassadorId, orderId])
  @@index([ambassadorId])
  @@index([paidOut])
  @@index([payoutId])
  @@index([createdAt])
  @@index([updatedAt])
}

model AmbassadorPayout {
  id            String                 @id @default(cuid())
  ambassadorId  String
  amount        Decimal                @db.Decimal(10, 2)
  method        String?
  reference     String?
  notes         String?
  processedById String?
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt
  commissions   AmbassadorCommission[]
  ambassador    Ambassador             @relation(fields: [ambassadorId], references: [id], onDelete: Cascade)

  @@index([ambassadorId])
  @@index([processedById])
  @@index([createdAt])
  @@index([updatedAt])
}

model Article {
  id              String               @id @default(cuid())
  title           String
  slug            String               @unique
  excerpt         String?
  content         String?
  imageUrl        String?
  author          String?
  category        String?
  tags            String?
  readTime        Int?
  difficulty      String?
  isFeatured      Boolean              @default(false)
  isPublished     Boolean              @default(false)
  publishedAt     DateTime?
  locale          String               @default("en")
  metaTitle       String?
  metaDescription String?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  translations    ArticleTranslation[]

  @@index([category])
  @@index([isPublished])
  @@index([createdAt])
  @@index([updatedAt])
}

model ArticleTranslation {
  id              String             @id @default(cuid())
  articleId       String
  locale          String
  title           String?
  excerpt         String?
  content         String?
  metaTitle       String?
  metaDescription String?
  contentHash     String?
  translatedBy    String?            @default("gpt-4o-mini")
  isApproved      Boolean            @default(false)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  qualityLevel    TranslationQuality @default(draft)
  article         Article            @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@unique([articleId, locale])
  @@index([articleId])
  @@index([locale])
  @@index([createdAt])
  @@index([updatedAt])
}

model AuditLog {
  id           String   @id @default(cuid())
  userId       String?
  action       String
  entityType   String
  entityId     String?
  details      String?
  changes      Json?    // DB-003: Structured {before, after} diff
  previousHash String?  // DB-003: SHA-256 hash of previous entry (tamper detection)
  currentHash  String?  // DB-003: SHA-256 hash of this entry
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt

  @@index([action])
  @@index([action, createdAt])
  @@index([createdAt])
  @@index([entityType])
  @@index([entityType, entityId])
  @@index([userId])
  @@index([updatedAt])
}

model BankAccount {
  id             String            @id @default(cuid())
  name           String
  accountNumber  String?
  institution    String
  type           String            @default("CHECKING")
  currency       String            @default("CAD")
  chartAccountId String?
  currentBalance Decimal           @default(0) @db.Decimal(12, 2)
  lastSyncAt     DateTime?
  apiCredentials String?
  isActive       Boolean           @default(true)
  isDefault      Boolean           @default(false)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  transactions   BankTransaction[]

  @@index([chartAccountId])
  @@index([type])
  @@index([createdAt])
  @@index([updatedAt])
}

model BankTransaction {
  id                   String               @id @default(cuid())
  bankAccountId        String
  date                 DateTime
  description          String
  amount               Decimal              @db.Decimal(12, 2)
  type                 String
  category             String?
  reference            String?
  reconciliationStatus ReconciliationStatus @default(PENDING)
  matchedEntryId       String?
  matchedEntry         JournalEntry?        @relation("BankTransactionMatchedEntry", fields: [matchedEntryId], references: [id], onDelete: SetNull)
  matchedAt            DateTime?
  matchedBy            String?
  importBatch          String?
  importedAt           DateTime             @default(now())
  rawData              Json?
  createdAt            DateTime             @default(now())
  deletedAt            DateTime?
  bankAccount          BankAccount          @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)

  @@index([bankAccountId])
  @@index([date])
  @@index([reconciliationStatus])
  @@index([deletedAt])
  @@index([reconciliationStatus, date]) // Phase 9: Composite for unreconciled transaction queries
  @@index([bankAccountId, date]) // Phase 9: Composite for bank statement queries
  @@index([matchedEntryId])
  @@index([createdAt])
}

model BlogPost {
  id              String                @id @default(cuid())
  title           String
  slug            String                @unique
  excerpt         String?
  content         String?
  imageUrl        String?
  author          String?
  category        String?
  tags            String?
  readTime        Int?
  isFeatured      Boolean               @default(false)
  isPublished     Boolean               @default(false)
  publishedAt     DateTime?
  locale          String                @default("en")
  metaTitle       String?
  metaDescription String?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  translations    BlogPostTranslation[]

  @@index([category])
  @@index([isPublished])
  @@index([slug])
  @@index([createdAt])
  @@index([updatedAt])
}

model BlogPostTranslation {
  id              String             @id @default(cuid())
  blogPostId      String
  locale          String
  title           String?
  excerpt         String?
  content         String?
  metaTitle       String?
  metaDescription String?
  contentHash     String?
  translatedBy    String?            @default("gpt-4o-mini")
  isApproved      Boolean            @default(false)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  qualityLevel    TranslationQuality @default(draft)
  blogPost        BlogPost           @relation(fields: [blogPostId], references: [id], onDelete: Cascade)

  @@unique([blogPostId, locale])
  @@index([blogPostId])
  @@index([locale])
  @@index([createdAt])
  @@index([updatedAt])
}

model Budget {
  id        String       @id @default(cuid())
  name      String
  year      Int
  isActive  Boolean      @default(true)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  lines     BudgetLine[]

  @@index([year])
  @@index([createdAt])
  @@index([updatedAt])
}

model BudgetLine {
  id          String   @id @default(cuid())
  budgetId    String
  accountCode String
  accountName String
  type        String   @default("EXPENSE")
  january     Decimal  @default(0) @db.Decimal(12, 2)
  february    Decimal  @default(0) @db.Decimal(12, 2)
  march       Decimal  @default(0) @db.Decimal(12, 2)
  april       Decimal  @default(0) @db.Decimal(12, 2)
  may         Decimal  @default(0) @db.Decimal(12, 2)
  june        Decimal  @default(0) @db.Decimal(12, 2)
  july        Decimal  @default(0) @db.Decimal(12, 2)
  august      Decimal  @default(0) @db.Decimal(12, 2)
  september   Decimal  @default(0) @db.Decimal(12, 2)
  october     Decimal  @default(0) @db.Decimal(12, 2)
  november    Decimal  @default(0) @db.Decimal(12, 2)
  december    Decimal  @default(0) @db.Decimal(12, 2)
  total       Decimal  @default(0) @db.Decimal(12, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  budget      Budget   @relation(fields: [budgetId], references: [id], onDelete: Cascade)

  @@index([accountCode])
  @@index([budgetId])
  @@index([createdAt])
  @@index([updatedAt])
}

model Bundle {
  id          String       @id @default(cuid())
  name        String
  slug        String       @unique
  description String?
  image       String?
  discount    Decimal      @default(0) @db.Decimal(5, 2)
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  items       BundleItem[]

  @@index([isActive])
  @@index([createdAt])
  @@index([updatedAt])
}

model BundleItem {
  id        String  @id @default(cuid())
  bundleId  String
  productId String
  formatId  String?
  quantity  Int     @default(1)
  bundle    Bundle  @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([bundleId])
  @@index([formatId])
  @@index([productId])
}

model Cart {
  id           String     @id @default(cuid())
  userId       String?    @unique
  sessionId    String?    @unique
  currencyCode String     @default("CAD")
  promoCodeId  String?
  expiresAt    DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  items        CartItem[]

  @@index([promoCodeId])
  @@index([sessionId])
  @@index([userId])
  @@index([createdAt])
  @@index([updatedAt])
}

model CartItem {
  id         String   @id @default(cuid())
  cartId     String
  productId  String
  formatId   String?
  quantity   Int      @default(1)
  priceAtAdd Decimal  @db.Decimal(10, 2)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  cart       Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)

  @@unique([cartId, productId, formatId])
  @@index([cartId])
  @@index([productId])
  @@index([createdAt])
  @@index([updatedAt])
}

model Category {
  id           String                @id @default(cuid())
  name         String
  slug         String                @unique
  description  String?
  imageUrl     String?
  sortOrder    Int                   @default(0)
  isActive     Boolean               @default(true)
  parentId     String?
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  parent       Category?             @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children     Category[]            @relation("CategoryHierarchy")
  translations CategoryTranslation[]
  products     Product[]

  @@index([parentId])
  @@index([isActive])
  @@index([name])
  @@index([isActive, sortOrder])
  @@index([createdAt])
  @@index([updatedAt])
}

model CategoryTranslation {
  id           String             @id @default(cuid())
  categoryId   String
  locale       String
  name         String?
  description  String?
  contentHash  String?
  translatedBy String?            @default("gpt-4o-mini")
  isApproved   Boolean            @default(false)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  qualityLevel TranslationQuality @default(draft)
  category     Category           @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([categoryId, locale])
  @@index([categoryId])
  @@index([locale])
  @@index([createdAt])
  @@index([updatedAt])
}

model ChartOfAccount {
  id                 String           @id @default(cuid())
  code               String           @unique
  name               String
  description        String?
  type               AccountType
  parentId           String?
  normalBalance      String           @default("DEBIT")
  isActive           Boolean          @default(true)
  isSystem           Boolean          @default(false)
  allowDirectEntry   Boolean          @default(true)
  // GIFI mapping for CRA T2 corporate tax return
  gifiCode           String? // GIFI code (e.g. "1001", "8000")
  gifiName           String? // GIFI name for reference
  // CCA (Capital Cost Allowance) for depreciable assets
  ccaClass           Int? // CCA class number (e.g. 8, 10, 50)
  ccaRate            Decimal? @db.Decimal(5, 4) // F-008: CCA rate (was Float, now Decimal for tax precision)
  // Deductibility
  deductiblePercent  Int? // 100 = fully, 50 = meals, 0 = non-deductible
  isContra           Boolean          @default(false)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  parent             ChartOfAccount?  @relation("ChartOfAccountToChartOfAccount", fields: [parentId], references: [id])
  children           ChartOfAccount[] @relation("ChartOfAccountToChartOfAccount")
  journalLines       JournalLine[]
  fixedAssets        FixedAsset[]     @relation("AssetAccount")
  depreciationAssets FixedAsset[]     @relation("DepreciationAccount")
  expenseAssets      FixedAsset[]     @relation("ExpenseAccount")
  bankRules          BankRule[]       @relation("bankRuleAccount")
  expenses           Expense[]        @relation("expenseAccount")

  @@index([parentId])
  @@index([type])
  @@index([gifiCode])
  @@index([createdAt])
  @@index([updatedAt])
}

model ChatConversation {
  id              String        @id @default(cuid())
  visitorId       String
  visitorName     String?
  visitorEmail    String?
  visitorLanguage String        @default("en")
  userId          String?
  status          ChatStatus    @default(ACTIVE)
  isOnline        Boolean       @default(true)
  userAgent       String?
  ipCountry       String?
  currentPage     String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  lastMessageAt   DateTime      @default(now())
  closedAt        DateTime?
  messages        ChatMessage[]

  @@index([lastMessageAt])
  @@index([status])
  @@index([userId])
  @@index([visitorId])
  // FIX F-037: Composite index for the common query pattern: findFirst where visitorId + status
  @@index([visitorId, status])
  @@index([createdAt])
  @@index([updatedAt])
}

model ChatMessage {
  id              String           @id @default(cuid())
  conversationId  String
  content         String
  contentOriginal String?
  sender          ChatSender
  senderName      String?
  language        String           @default("en")
  translatedTo    String?
  isRead          Boolean          @default(false)
  isFromBot       Boolean          @default(false)
  metadata        String?
  type            ChatMessageType  @default(TEXT)
  attachmentUrl   String?
  attachmentName  String?
  attachmentSize  Int?
  createdAt       DateTime         @default(now())
  conversation    ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
}

model ChatSettings {
  id                 String   @id @default("default")
  isAdminOnline      Boolean  @default(false)
  adminLanguage      String   @default("fr")
  chatbotEnabled     Boolean  @default(true)
  chatbotGreeting    String?
  chatbotPrompt      String?
  notifyEmail        String?
  notifyOnNewChat    Boolean  @default(true)
  notifyOnEscalation Boolean  @default(true)
  widgetColor        String   @default("#f97316")
  widgetPosition     String   @default("bottom-right")
  updatedAt          DateTime @updatedAt
  @@index([updatedAt])
}

model ClientReference {
  id          String   @id @default(cuid())
  name        String
  logoUrl     String?
  industry    String?
  website     String?
  description String?
  isPublished Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([industry])
  @@index([isPublished])
  @@index([createdAt])
  @@index([updatedAt])
}

model Company {
  id             String            @id @default(cuid())
  name           String
  slug           String            @unique
  contactEmail   String
  phone          String?
  billingAddress String?
  billingCity    String?
  billingState   String?
  billingPostal  String?
  billingCountry String?
  ownerId        String            @unique
  isActive       Boolean           @default(true)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  owner          User              @relation(fields: [ownerId], references: [id], onDelete: Restrict)
  customers      CompanyCustomer[]
  purchases      Purchase[]

  @@index([slug])
  @@index([createdAt])
  @@index([updatedAt])
}

model CompanyCustomer {
  id         String   @id @default(cuid())
  companyId  String
  customerId String
  addedAt    DateTime @default(now())
  addedBy    String?
  company    Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([companyId, customerId])
  @@index([companyId])
  @@index([customerId])
}

model Conversation {
  id            String             @id @default(cuid())
  userId        String
  subject       String?
  status        ConversationStatus @default(OPEN)
  assignedToId  String?
  priority      Int                @default(0)
  tags          String?
  lastMessageAt DateTime           @default(now())
  unreadCount   Int                @default(1)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  assignedTo    User?              @relation("Conversation_assignedToIdToUser", fields: [assignedToId], references: [id])
  user          User               @relation("Conversation_userIdToUser", fields: [userId], references: [id], onDelete: Cascade)
  messages      Message[]

  @@index([assignedToId])
  @@index([lastMessageAt])
  @@index([status])
  @@index([userId])
  @@index([createdAt])
  @@index([updatedAt])
}

model CourseAccess {
  id                  String    @id @default(cuid())
  userId              String
  productId           String
  purchaseId          String    @unique
  progress            Int       @default(0)
  lastAccessedAt      DateTime?
  completedAt         DateTime?
  certificateUrl      String?
  certificateNumber   String?
  certificateIssuedAt DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  product             Product   @relation(fields: [productId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  purchase            Purchase  @relation(fields: [purchaseId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  user                User      @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([userId, productId])
  @@index([productId])
  @@index([userId])
  @@index([createdAt])
  @@index([updatedAt])
}

model CreditNote {
  id               String           @id @default(cuid())
  creditNoteNumber String           @unique
  invoiceId        String?
  orderId          String?
  customerName     String
  customerEmail    String?
  subtotal         Decimal          @db.Decimal(12, 2)
  taxTps           Decimal          @default(0) @db.Decimal(12, 2)
  taxTvq           Decimal          @default(0) @db.Decimal(12, 2)
  taxTvh           Decimal          @default(0) @db.Decimal(12, 2)
  total            Decimal          @db.Decimal(12, 2)
  currency         String           @default("CAD")
  reason           String
  status           CreditNoteStatus @default(DRAFT)
  issuedAt         DateTime?
  issuedBy         String?
  voidedAt         DateTime?
  voidedBy         String?
  journalEntryId   String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  deletedAt        DateTime?
  taxPst           Decimal          @default(0) @db.Decimal(12, 2)
  invoice          CustomerInvoice? @relation(fields: [invoiceId], references: [id])

  @@index([createdAt])
  @@index([invoiceId])
  @@index([journalEntryId])
  @@index([orderId])
  @@index([status])
  @@index([deletedAt])
  @@index([updatedAt])
}

model Currency {
  id            String   @id @default(cuid())
  code          String   @unique
  name          String
  symbol        String
  exchangeRate  Decimal  @default(1.000000) @db.Decimal(10, 6)
  rateUpdatedAt DateTime @default(now())
  isDefault     Boolean  @default(false)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  orders        Order[]

  @@index([code])
  @@index([createdAt])
  @@index([updatedAt])
}

model CustomerInvoice {
  id              String                @id @default(cuid())
  invoiceNumber   String                @unique
  customerId      String?
  customerName    String
  customerEmail   String?
  customerAddress String?
  orderId         String?
  subtotal        Decimal               @db.Decimal(12, 2)
  shippingCost    Decimal               @default(0) @db.Decimal(12, 2)
  discount        Decimal               @default(0) @db.Decimal(12, 2)
  taxTps          Decimal               @default(0) @db.Decimal(12, 2)
  taxTvq          Decimal               @default(0) @db.Decimal(12, 2)
  taxTvh          Decimal               @default(0) @db.Decimal(12, 2)
  total           Decimal               @db.Decimal(12, 2)
  amountPaid      Decimal               @default(0) @db.Decimal(12, 2)
  balance         Decimal               @db.Decimal(12, 2)
  currency        String                @default("CAD")
  invoiceDate     DateTime
  dueDate         DateTime
  paidAt          DateTime?
  status          InvoiceStatus         @default(SENT)
  pdfUrl          String?
  notes           String?
  remindersSent   Int                   @default(0)
  lastReminderAt  DateTime?
  journalEntryId  String?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  deletedAt       DateTime?
  taxPst          Decimal               @default(0) @db.Decimal(12, 2)
  creditNotes     CreditNote[]
  items           CustomerInvoiceItem[]

  @@index([customerId])
  @@index([dueDate])
  @@index([journalEntryId])
  @@index([orderId])
  @@index([status])
  @@index([deletedAt])
  @@index([invoiceDate]) // S10: Index for date range filtering (gst-qst-declaration, tax reports)
  @@index([paidAt]) // S10: Index for payment reconciliation queries
  @@index([status, dueDate]) // Phase 9: Composite for overdue invoice queries
  @@index([status, deletedAt]) // S10: Composite for active invoice queries (aging, alerts)
  @@index([customerId, status]) // Phase 9: Composite for customer invoice listing
  @@index([createdAt])
  @@index([updatedAt])
}

model CustomerInvoiceItem {
  id          String          @id @default(cuid())
  invoiceId   String
  description String
  quantity    Int             @default(1)
  unitPrice   Decimal         @db.Decimal(12, 2)
  discount    Decimal         @default(0) @db.Decimal(12, 2)
  total       Decimal         @db.Decimal(12, 2)
  productId   String?
  productSku  String?
  createdAt   DateTime        @default(now())
  invoice     CustomerInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([productId])
  @@index([createdAt])
}

model Discount {
  id           String       @id @default(cuid())
  name         String
  type         DiscountType @default(PERCENTAGE)
  value        Decimal      @db.Decimal(10, 2)
  appliesToAll Boolean      @default(false)
  categoryId   String?
  productId    String?
  startsAt     DateTime?
  endsAt       DateTime?
  badge        String?
  badgeColor   String?
  isActive     Boolean      @default(true)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([categoryId])
  @@index([isActive])
  @@index([productId])
  @@index([startsAt, endsAt])
  @@index([createdAt])
  @@index([updatedAt])
}

model EmailLog {
  id         String   @id @default(cuid())
  templateId String?
  to         String
  subject    String
  status     String   @default("sent")
  error      String?
  messageId  String?
  sentAt     DateTime @default(now())

  @@index([sentAt])
  @@index([templateId])
  @@index([to])
  @@index([to, status])
  @@index([messageId])
  @@index([status])
}

// Faille #11: Persistent bounce tracking (was in-memory only, lost on restart)
model EmailBounce {
  id         String   @id @default(cuid())
  email      String
  bounceType String   // 'hard' or 'soft'
  provider   String
  reason     String?
  messageId  String?
  count      Int      @default(1)
  lastBounce DateTime @default(now())
  createdAt  DateTime @default(now())

  @@index([email])
  @@index([email, bounceType])
  @@index([messageId])
  @@index([createdAt])
}

// Faille #12: Persistent suppression list for hard-bounced/complained emails
model EmailSuppression {
  id        String   @id @default(cuid())
  email     String   @unique
  reason    String   // 'hard_bounce', 'complaint', 'manual'
  provider  String?
  createdAt DateTime @default(now())
  expiresAt DateTime? // null = permanent suppression

  @@index([email])
  @@index([createdAt])
}

model EmailTemplate {
  id          String   @id @default(cuid())
  name        String   @unique
  subject     String
  htmlContent String
  textContent String?
  variables   String[]
  isActive    Boolean  @default(true)
  locale      String   @default("fr")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  @@index([createdAt])
  @@index([updatedAt])
}

model Expense {
  id            String   @id @default(cuid())
  expenseNumber String   @unique
  date          DateTime
  description   String

  // Amounts
  subtotal Decimal @db.Decimal(12, 2)
  taxGst   Decimal @default(0) @db.Decimal(12, 2)
  taxQst   Decimal @default(0) @db.Decimal(12, 2)
  taxOther Decimal @default(0) @db.Decimal(12, 2)
  total    Decimal @db.Decimal(12, 2)

  // Categorization
  category          String // meals, travel, office, professional, advertising, etc.
  accountId         String?
  account           ChartOfAccount? @relation("expenseAccount", fields: [accountId], references: [id])
  deductiblePercent Int             @default(100) // 100, 50, or 0

  // Vendor
  vendorName      String?
  vendorTaxNumber String? // GST/QST registration number

  // Receipt
  receiptUrl String?
  ocrData    Json?

  // Approval
  status          ExpenseStatus @default(DRAFT)
  submittedBy     String?
  approvedBy      String?
  approvedAt      DateTime?
  rejectionReason String?

  // Mileage (if applicable)
  mileageKm   Float?
  mileageRate Float? // CRA rate per km

  // Payment
  paymentMethod String? // cash, credit_card, debit, company_card, reimbursement
  reimbursed    Boolean   @default(false)
  reimbursedAt  DateTime?

  // Relations
  journalEntryId String?

  notes     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([accountId])
  @@index([journalEntryId])
  @@index([status])
  @@index([category])
  @@index([date])
  @@index([deletedAt])
  @@index([createdAt])
  @@index([updatedAt])
}

model Faq {
  id           String           @id @default(cuid())
  question     String
  answer       String
  category     String           @default("general")
  locale       String           @default("en")
  sortOrder    Int              @default(0)
  isPublished  Boolean          @default(true)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  translations FaqTranslation[]

  @@index([category])
  @@index([isPublished])
  @@index([createdAt])
  @@index([updatedAt])
}

model FaqTranslation {
  id           String             @id @default(cuid())
  faqId        String
  locale       String
  question     String
  answer       String
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  contentHash  String?
  translatedBy String?            @default("gpt-4o-mini")
  isApproved   Boolean            @default(false)
  qualityLevel TranslationQuality @default(draft)
  faq          Faq                @relation(fields: [faqId], references: [id], onDelete: Cascade)

  @@unique([faqId, locale])
  @@index([faqId])
  @@index([locale])
  @@index([createdAt])
  @@index([updatedAt])
}

model GiftCard {
  id                    String    @id @default(cuid())
  code                  String    @unique
  initialAmount         Decimal   @db.Decimal(10, 2)
  balance               Decimal   @db.Decimal(10, 2)
  currency              String    @default("CAD")
  purchaserId           String?
  recipientEmail        String?
  recipientName         String?
  message               String?
  isActive              Boolean   @default(true)
  expiresAt             DateTime?
  redeemedBy            String?
  stripePaymentIntentId String?   @unique // BUG E-21: Track payment intent to prevent double-use
  createdAt             DateTime  @default(now())
  purchaser             User?     @relation("GiftCard_purchaserIdToUser", fields: [purchaserId], references: [id])
  redeemer              User?     @relation("GiftCard_redeemedByToUser", fields: [redeemedBy], references: [id])

  @@index([code])
  @@index([purchaserId])
  @@index([redeemedBy])
  @@index([createdAt])
}

model Grade {
  id          String   @id @default(cuid())
  userId      String
  productId   String
  moduleId    String
  score       Decimal  @db.Decimal(5, 2)
  passed      Boolean
  attempts    Int      @default(1)
  completedAt DateTime @default(now())
  module      Module   @relation(fields: [moduleId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  product     Product  @relation(fields: [productId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  user        User     @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([userId, moduleId])
  @@index([productId])
  @@index([userId])
}

model Guide {
  id            String             @id @default(cuid())
  title         String
  slug          String             @unique
  description   String?
  category      String             @default("general")
  fileUrl       String?
  thumbnailUrl  String?
  format        String?
  pageCount     Int?
  isFeatured    Boolean            @default(false)
  isPublished   Boolean            @default(false)
  locale        String             @default("en")
  downloadCount Int                @default(0)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  translations  GuideTranslation[]

  @@index([category])
  @@index([isPublished])
  @@index([slug])
  @@index([createdAt])
  @@index([updatedAt])
}

model GuideTranslation {
  id           String             @id @default(cuid())
  guideId      String
  locale       String
  title        String?
  description  String?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  contentHash  String?
  translatedBy String?            @default("gpt-4o-mini")
  isApproved   Boolean            @default(false)
  qualityLevel TranslationQuality @default(draft)
  guide        Guide              @relation(fields: [guideId], references: [id], onDelete: Cascade)

  @@unique([guideId, locale])
  @@index([guideId])
  @@index([locale])
  @@index([createdAt])
  @@index([updatedAt])
}

model HeroSlide {
  id               String                 @id @default(cuid())
  slug             String                 @unique
  mediaType        HeroMediaType          @default(IMAGE)
  backgroundUrl    String
  backgroundMobile String?
  overlayOpacity   Int                    @default(70)
  overlayGradient  String?
  badgeText        String?
  title            String
  subtitle         String?
  ctaText          String?
  ctaUrl           String?
  ctaStyle         String?                @default("primary")
  cta2Text         String?
  cta2Url          String?
  cta2Style        String?                @default("outline")
  statsJson        String?
  sortOrder        Int                    @default(0)
  isActive         Boolean                @default(true)
  startDate        DateTime?
  endDate          DateTime?
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  translations     HeroSlideTranslation[]

  @@index([isActive, sortOrder])
  @@index([createdAt])
  @@index([updatedAt])
}

model HeroSlideTranslation {
  id           String             @id @default(cuid())
  slideId      String
  locale       String
  badgeText    String?
  title        String
  subtitle     String?
  ctaText      String?
  cta2Text     String?
  statsJson    String?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  contentHash  String?
  translatedBy String?            @default("gpt-4o-mini")
  isApproved   Boolean            @default(false)
  qualityLevel TranslationQuality @default(draft)
  heroSlide    HeroSlide          @relation(fields: [slideId], references: [id], onDelete: Cascade)

  @@unique([slideId, locale])
  @@index([locale])
  @@index([slideId])
  @@index([createdAt])
  @@index([updatedAt])
}

model InventoryReservation {
  id         String                     @id @default(cuid())
  productId  String
  formatId   String?
  quantity   Int
  orderId    String?
  cartId     String?
  status     InventoryReservationStatus @default(RESERVED)
  expiresAt  DateTime
  createdAt  DateTime                   @default(now())
  consumedAt DateTime?
  releasedAt DateTime?

  @@index([cartId])
  @@index([expiresAt])
  @@index([formatId])
  @@index([orderId])
  @@index([productId])
  @@index([status])
  @@index([createdAt])
}

model InventoryTransaction {
  id                String                   @id @default(cuid())
  productId         String
  formatId          String?
  type              InventoryTransactionType
  quantity          Int
  unitCost          Decimal                  @db.Decimal(12, 4)
  runningWAC        Decimal                  @db.Decimal(12, 4)
  orderId           String?
  supplierInvoiceId String?
  reason            String?
  createdBy         String?
  createdAt         DateTime                 @default(now())

  @@index([createdAt])
  @@index([orderId])
  @@index([productId, formatId])
  @@index([supplierInvoiceId])
  @@index([type])
}

// TODO #55: Add @default(cuid()) to id fields in accounting models:
//   JournalEntry, JournalLine, TaxReport, BankTransaction, AccountingPeriod, AccountingAlert
//   Currently these models require manual ID generation which is error-prone.

model JournalEntry {
  id           String             @id @default(cuid())
  entryNumber  String             @unique
  date         DateTime
  description  String
  type         JournalEntryType   @default(MANUAL)
  status       JournalEntryStatus @default(DRAFT)
  reference    String?
  orderId      String?
  createdBy    String
  postedBy     String?
  postedAt     DateTime?
  voidedBy     String?
  voidedAt     DateTime?
  voidReason   String?
  attachments  String?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  deletedAt    DateTime?
  currency     String             @default("CAD")
  exchangeRate Decimal            @default(1.000000) @db.Decimal(10, 6)
  lines            JournalLine[]
  bankTransactions BankTransaction[] @relation("BankTransactionMatchedEntry")

  @@index([date])
  @@index([orderId])
  @@index([status])
  @@index([type])
  @@index([status, date])
  @@index([deletedAt])
  @@index([reference]) // #56 - Index for reference lookups (reconciliation, Stripe sync)
  @@index([createdBy]) // S10: Index for audit trail lookups by creator
  @@index([type, deletedAt]) // S10: Composite for stripe-sync queries (find by type, exclude deleted)
  @@index([status, deletedAt]) // S10: Composite for active entry queries by status
  @@index([createdAt])
  @@index([updatedAt])
}

model JournalLine {
  id          String         @id @default(cuid())
  entryId     String
  accountId   String
  description String?
  debit       Decimal        @default(0) @db.Decimal(12, 2)
  credit      Decimal        @default(0) @db.Decimal(12, 2)
  costCenter  String?
  projectCode String?
  createdAt   DateTime       @default(now())
  account     ChartOfAccount @relation(fields: [accountId], references: [id], onDelete: Restrict)
  entry       JournalEntry   @relation(fields: [entryId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([entryId])
  @@index([accountId, entryId])
  @@index([createdAt])
}

model LoyaltyTransaction {
  id           String                 @id @default(cuid())
  userId       String
  type         LoyaltyTransactionType
  points       Int
  description  String?
  orderId      String?
  referralId   String?
  balanceAfter Int
  metadata     String?
  createdAt    DateTime               @default(now())
  expiresAt    DateTime?
  user         User                   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([expiresAt])
  @@index([orderId])
  @@index([referralId])
  @@index([type])
  @@index([userId])
  @@index([userId, type]) // F-070: Composite for duplicate detection (EARN_SIGNUP, EARN_BIRTHDAY)
}

model Media {
  id           String   @id @default(cuid())
  filename     String
  originalName String
  mimeType     String
  size         Int
  url          String
  alt          String?
  folder       String   @default("general")
  // TODO (F14): Add FK relation to User model for uploadedBy field
  // Requires coordinated migration: uploadedBy String? @db.VarChar(255)
  // uploader User? @relation("MediaUploader", fields: [uploadedBy], references: [id])
  uploadedBy   String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  width        Int?     // F-50: Image width for display/optimization
  height       Int?     // F-50: Image height for display/optimization

  @@index([folder])
  @@index([mimeType])
  @@index([uploadedBy])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([originalName]) // F-56: Search by filename
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  senderId       String
  type           MessageType  @default(TEXT)
  content        String
  attachmentUrl  String?
  attachmentName String?
  attachmentSize Int?
  readAt         DateTime?
  isSystem       Boolean      @default(false)
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation(fields: [senderId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([conversationId])
  @@index([createdAt])
  @@index([senderId])
}

model Module {
  id          String   @id @default(cuid())
  productId   String
  name        String
  description String?
  sortOrder   Int      @default(0)
  duration    Int?
  contentUrl  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  grades      Grade[]
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([createdAt])
  @@index([updatedAt])
}

model NewsArticle {
  id           String                   @id @default(cuid())
  title        String
  slug         String                   @unique
  excerpt      String?
  content      String?
  imageUrl     String?
  type         String                   @default("news")
  author       String?
  isFeatured   Boolean                  @default(false)
  isPublished  Boolean                  @default(false)
  publishedAt  DateTime?
  locale       String                   @default("en")
  createdAt    DateTime                 @default(now())
  updatedAt    DateTime                 @updatedAt
  translations NewsArticleTranslation[]

  @@index([isPublished])
  @@index([slug])
  @@index([type])
  @@index([createdAt])
  @@index([updatedAt])
}

model NewsArticleTranslation {
  id            String             @id @default(cuid())
  newsArticleId String
  locale        String
  title         String?
  excerpt       String?
  content       String?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  contentHash   String?
  translatedBy  String?            @default("gpt-4o-mini")
  isApproved    Boolean            @default(false)
  qualityLevel  TranslationQuality @default(draft)
  newsArticle   NewsArticle        @relation(fields: [newsArticleId], references: [id], onDelete: Cascade)

  @@unique([newsArticleId, locale])
  @@index([newsArticleId])
  @@index([locale])
  @@index([createdAt])
  @@index([updatedAt])
}

model NewsletterSubscriber {
  id             String    @id @default(cuid())
  email          String    @unique
  name           String?
  isActive       Boolean   @default(true)
  source         String?
  locale         String    @default("fr")
  subscribedAt   DateTime  @default(now())
  unsubscribedAt DateTime?
  birthDate      DateTime?

  @@index([isActive])
  @@index([subscribedAt])
  @@index([locale])
}

model NotificationPreference {
  id             String   @id @default(cuid())
  userId         String   @unique
  orderUpdates   Boolean  @default(true)
  promotions     Boolean  @default(true)
  newsletter     Boolean  @default(true)
  weeklyDigest   Boolean  @default(false)
  priceDrops     Boolean  @default(false)
  stockAlerts    Boolean  @default(true)
  productReviews Boolean  @default(false)
  birthdayOffers Boolean  @default(true)
  loyaltyUpdates Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([updatedAt])
}

model Order {
  id                    String          @id @default(cuid())
  orderNumber           String          @unique
  userId                String?
  subtotal              Decimal         @db.Decimal(10, 2)
  shippingCost          Decimal         @default(0) @db.Decimal(10, 2)
  discount              Decimal         @default(0) @db.Decimal(10, 2)
  tax                   Decimal         @default(0) @db.Decimal(10, 2)
  total                 Decimal         @db.Decimal(10, 2)
  currencyId            String
  exchangeRate          Decimal         @default(1) @db.Decimal(10, 6)
  promoCode             String?
  promoDiscount         Decimal?        @db.Decimal(10, 2)
  giftCardCode          String?
  giftCardDiscount      Decimal?        @db.Decimal(10, 2)
  paymentMethod         PaymentMethod?
  paymentStatus         String          @default("PENDING")
  stripePaymentId       String?
  paypalOrderId         String?
  status                String          @default("PENDING")
  shippingName          String
  shippingAddress1      String
  shippingAddress2      String?
  shippingCity          String
  shippingState         String
  shippingPostal        String
  shippingCountry       String          @default("CA")
  shippingPhone         String?
  carrier               String?
  trackingNumber        String?
  trackingUrl           String?
  shippedAt             DateTime?
  deliveredAt           DateTime?
  customerNotes         String?
  adminNotes            String?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  taxTps                Decimal         @default(0) @db.Decimal(10, 2)
  taxTvh                Decimal         @default(0) @db.Decimal(10, 2)
  taxTvq                Decimal         @default(0) @db.Decimal(10, 2)
  orderType             String          @default("STANDARD")
  parentOrderId         String?
  replacementReason     String?
  taxPst                Decimal         @default(0) @db.Decimal(10, 2)
  idempotencyKey        String?         @unique
  user                  User?           @relation(fields: [userId], references: [id], onDelete: Restrict)
  currency              Currency        @relation(fields: [currencyId], references: [id], onDelete: Restrict)
  parentOrder           Order?          @relation("OrderToOrder", fields: [parentOrderId], references: [id])
  replacementOrders     Order[]         @relation("OrderToOrder")
  billingName           String?
  billingAddress1       String?
  billingAddress2       String?
  billingCity           String?
  billingState          String?
  billingPostal         String?
  billingCountry        String?
  billingSameAsShipping Boolean         @default(true)
  items                 OrderItem[]
  paymentErrors         PaymentError[]
  returnRequests        ReturnRequest[]

  @@index([createdAt])
  @@index([currencyId])
  @@index([orderNumber])
  @@index([parentOrderId])
  @@index([paymentStatus])
  @@index([promoCode])
  @@index([status])
  @@index([stripePaymentId])
  @@index([paypalOrderId])
  @@index([userId])
  @@index([userId, status])
  @@index([userId, createdAt])
  @@index([status, createdAt])
  @@index([paymentStatus, createdAt]) // S10: Composite for social-proof & abandoned-cart queries filtering by paymentStatus + date range
  @@index([status, paymentStatus]) // S10: Composite for queries filtering orders by both status and payment status
  @@index([updatedAt])
}

model PaymentError {
  id              String    @id @default(cuid())
  orderId         String?
  stripePaymentId String?
  errorType       String
  errorMessage    String
  amount          Decimal   @default(0) @db.Decimal(10, 2)
  currency        String    @default("CAD")
  customerEmail   String?
  metadata        String?
  createdAt       DateTime  @default(now())
  deletedAt       DateTime?
  order           Order?    @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([createdAt])
  @@index([orderId])
  @@index([errorType])
  @@index([deletedAt])
}

model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  productId   String
  formatId    String?
  productName String
  formatName  String?
  sku         String?
  quantity    Int
  unitPrice   Decimal  @db.Decimal(10, 2)
  discount    Decimal  @default(0) @db.Decimal(10, 2)
  total       Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now())
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([formatId])
  @@index([orderId])
  @@index([productId])
  @@index([orderId, productId])
  @@index([productId, formatId]) // P-09: composite for product-history DISTINCT ON (productId, formatId)
  @@index([productId, formatId, createdAt]) // P-09: composite for latest price per (productId, formatId) ordered by date
  @@index([createdAt])
}

model Page {
  id              String            @id @default(cuid())
  title           String
  slug            String            @unique
  content         String
  excerpt         String?
  metaTitle       String?
  metaDescription String?
  locale          String            @default("en")
  isPublished     Boolean           @default(false)
  publishedAt     DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  createdBy       String?
  template        String            @default("default")
  translations    PageTranslation[]

  @@index([isPublished])
  @@index([slug])
  @@index([createdAt])
  @@index([updatedAt])
}

model PageTranslation {
  id              String             @id @default(cuid())
  pageId          String
  locale          String
  title           String
  content         String
  metaTitle       String?
  metaDescription String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  contentHash     String?
  translatedBy    String?            @default("gpt-4o-mini")
  isApproved      Boolean            @default(false)
  qualityLevel    TranslationQuality @default(draft)
  page            Page               @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@unique([pageId, locale])
  @@index([locale])
  @@index([pageId])
  @@index([createdAt])
  @@index([updatedAt])
}

model PasswordHistory {
  id        String   @id @default(cuid())
  userId    String
  password  String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([userId])
}

model PaymentMethodConfig {
  id          String   @id @default(cuid())
  countryCode String
  methodType  String
  provider    String
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  minAmount   Decimal? @db.Decimal(10, 2)
  maxAmount   Decimal? @db.Decimal(10, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([countryCode, methodType])
  @@index([countryCode, isActive])
  @@index([createdAt])
  @@index([updatedAt])
}

model Permission {
  id               String                      @id @default(cuid())
  code             String                      @unique
  name             String
  description      String?
  module           String
  defaultOwner     Boolean                     @default(true)
  defaultEmployee  Boolean                     @default(false)
  defaultClient    Boolean                     @default(false)
  defaultCustomer  Boolean                     @default(false)
  createdAt        DateTime                    @default(now())
  groupPermissions PermissionGroupPermission[]

  @@index([module])
  @@index([createdAt])
}

model PermissionGroup {
  id          String                      @id @default(cuid())
  name        String
  description String?
  color       String?
  isActive    Boolean                     @default(true)
  createdAt   DateTime                    @default(now())
  updatedAt   DateTime                    @updatedAt
  permissions PermissionGroupPermission[]
  users       UserPermissionGroup[]
  @@index([createdAt])
  @@index([updatedAt])
}

model PermissionGroupPermission {
  id           String          @id @default(cuid())
  groupId      String
  permissionId String
  createdAt    DateTime        @default(now())
  group        PermissionGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  permission   Permission      @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([groupId, permissionId])
  @@index([groupId])
  @@index([permissionId])
  @@index([createdAt])
}

model PriceWatch {
  id            String    @id @default(cuid())
  userId        String
  productId     String
  originalPrice Decimal   @db.Decimal(10, 2)
  targetPrice   Decimal?  @db.Decimal(10, 2)
  notified      Boolean   @default(false)
  notifiedAt    DateTime?
  createdAt     DateTime  @default(now())
  product       Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([productId, notified])
  @@index([createdAt])
}

model Product {
  id                  String               @id @default(cuid())
  name                String
  subtitle            String?
  slug                String               @unique
  shortDescription    String?
  description         String?
  fullDetails         String?
  specifications      String?
  productType         ProductType          @default(PEPTIDE)
  price               Decimal              @db.Decimal(10, 2)
  // BUG-058 NOTE: This field is named "compareAtPrice" (Shopify convention) for the
  // product-level strike-through price. The ProductFormat model uses "comparePrice"
  // (without "At") for the format-level strike-through price. Both represent the
  // original price before discount, but the naming differs for historical reasons.
  // Do NOT rename — that would require a DB migration. Frontend code maps both to
  // "comparePrice" when passing data to UI components.
  compareAtPrice      Decimal?             @db.Decimal(10, 2)
  imageUrl            String?
  videoUrl            String?
  certificateUrl      String?
  certificateName     String?
  dataSheetUrl        String?
  dataSheetName       String?
  categoryId          String
  weight              Decimal?             @db.Decimal(10, 3)
  dimensions          String?
  requiresShipping    Boolean              @default(true)
  sku                 String?              @unique
  barcode             String?
  manufacturer        String?
  origin              String?
  supplierUrl         String?
  purchaseCount       Int                  @default(0)
  averageRating       Decimal?             @db.Decimal(2, 1)
  reviewCount         Int                  @default(0)
  metaTitle           String?
  metaDescription     String?
  isActive            Boolean              @default(true)
  isFeatured          Boolean              @default(false)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  allowBackorder      Boolean              @default(false)
  aminoSequence       String?
  casNumber           String?
  coaUrl              String?
  hplcUrl             String?
  isBestseller        Boolean              @default(false)
  isNew               Boolean              @default(false)
  molecularFormula    String?
  molecularWeight     Decimal?             @db.Decimal(10, 2)
  msdsUrl             String?
  purity              Decimal?             @db.Decimal(5, 2)
  storageConditions   String?
  tags                String?
  stockQuantity       Int                  @default(0)
  trackInventory      Boolean              @default(true)
  // DB-011: Reorder management
  reorderPoint        Int?                 // Stock level that triggers reorder
  reorderQuantity     Int?                 // How many to reorder
  leadTimeDays        Int?                 // Supplier lead time
  // DB-012: Dynamic pricing
  dynamicPrice        Decimal?             @db.Decimal(10, 2) // AI-calculated optimal price
  priceStrategy       String?              // FIXED, DEMAND_BASED, COMPETITOR, MARGIN_TARGET
  customSections      Json?
  participateResearch String?
  relatedResearch     String?
  researchSays        String?
  bundleItems         BundleItem[]
  courseAccesses      CourseAccess[]
  grades              Grade[]
  modules             Module[]
  priceWatches        PriceWatch[]
  category            Category             @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  formats             ProductFormat[]
  images              ProductImage[]
  questions           ProductQuestion[]
  translations        ProductTranslation[]
  purchases           Purchase[]
  quantityDiscounts   QuantityDiscount[]
  reviews             Review[]
  stockAlerts         StockAlert[]
  upsellConfig        UpsellConfig?

  @@index([categoryId])
  @@index([isBestseller])
  @@index([isFeatured])
  @@index([isNew])
  @@index([productType])
  @@index([sku])
  @@index([slug])
  @@index([name])
  @@index([isActive]) // S10: Standalone index for active product filter (search, suggest, catalog queries)
  @@index([categoryId, isActive])
  @@index([isActive, createdAt])
  @@index([createdAt])
  @@index([updatedAt])
}

model ProductFormat {
  id                String                     @id @default(cuid())
  productId         String
  name              String
  description       String?
  price             Decimal                    @db.Decimal(10, 2)
  sku               String?                    @unique
  inStock           Boolean                    @default(true)
  stockQuantity     Int                        @default(0)
  sortOrder         Int                        @default(0)
  isDefault         Boolean                    @default(false)
  isActive          Boolean                    @default(true)
  createdAt         DateTime                   @default(now())
  updatedAt         DateTime                   @updatedAt
  availability      StockStatus                @default(IN_STOCK)
  availableDate     DateTime?
  barcode           String?
  // BUG-058 NOTE: This field is named "comparePrice" for the format-level
  // strike-through price. The Product model uses "compareAtPrice" (with "At",
  // Shopify convention) for the product-level equivalent. Both represent the
  // original price before discount. Do NOT rename — that would require a DB
  // migration. Frontend code normalizes both to "comparePrice" in UI components.
  comparePrice      Decimal?                   @db.Decimal(10, 2)
  discontinuedAt    DateTime?
  dosageMg          Decimal?                   @db.Decimal(10, 2)
  formatType        FormatType                 @default(VIAL_2ML)
  imageUrl          String?
  lowStockThreshold Int                        @default(5)
  trackInventory    Boolean                    @default(true)
  unitCount         Int?
  volumeMl          Decimal?                   @db.Decimal(10, 2)
  weightGrams       Int?
  costPrice         Decimal?                   @db.Decimal(10, 2)
  product           Product                    @relation(fields: [productId], references: [id], onDelete: Cascade)
  translations      ProductFormatTranslation[]

  @@index([availability])
  @@index([formatType])
  @@index([productId])
  @@index([sku])
  @@index([isActive])
  @@index([productId, isActive])
  @@index([productId, availability]) // S10: Composite for finding in-stock formats per product
  @@index([createdAt])
  @@index([updatedAt])
}

model ProductFormatTranslation {
  id            String             @id @default(cuid())
  formatId      String
  locale        String
  name          String?
  description   String?
  contentHash   String?
  translatedBy  String?            @default("gpt-4o-mini")
  isApproved    Boolean            @default(false)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  qualityLevel  TranslationQuality @default(draft)
  productFormat ProductFormat      @relation(fields: [formatId], references: [id], onDelete: Cascade)

  @@unique([formatId, locale])
  @@index([formatId])
  @@index([locale])
  @@index([createdAt])
  @@index([updatedAt])
}

model ProductImage {
  id        String   @id @default(cuid())
  productId String
  url       String
  alt       String?
  caption   String?
  sortOrder Int      @default(0)
  isPrimary Boolean  @default(false)
  width     Int?
  height    Int?
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([createdAt])
}

model ProductQuestion {
  id          String   @id @default(cuid())
  userId      String
  productId   String
  question    String
  answer      String?
  answeredBy  String?
  isPublished Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  product     Product  @relation(fields: [productId], references: [id], onDelete: Restrict)
  user        User     @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@index([isPublished])
  @@index([productId])
  @@index([userId])
  @@index([createdAt])
  @@index([updatedAt])
}

model ProductTranslation {
  id                  String             @id @default(cuid())
  productId           String
  locale              String
  name                String?
  subtitle            String?
  shortDescription    String?
  description         String?
  fullDetails         String?
  specifications      String?
  metaTitle           String?
  metaDescription     String?
  contentHash         String?
  translatedBy        String?            @default("gpt-4o-mini")
  isApproved          Boolean            @default(false)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  customSections      Json?
  participateResearch String?
  relatedResearch     String?
  researchSays        String?
  qualityLevel        TranslationQuality @default(draft)
  product             Product            @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, locale])
  @@index([locale])
  @@index([productId])
  @@index([createdAt])
  @@index([updatedAt])
}

model PromoCode {
  id                String           @id @default(cuid())
  code              String           @unique
  description       String?
  type              DiscountType     @default(PERCENTAGE)
  value             Decimal          @db.Decimal(10, 2)
  minOrderAmount    Decimal?         @db.Decimal(10, 2)
  maxDiscount       Decimal?         @db.Decimal(10, 2)
  usageLimit        Int?
  usageLimitPerUser Int?
  usageCount        Int              @default(0)
  startsAt          DateTime?
  endsAt            DateTime?
  firstOrderOnly    Boolean          @default(false)
  productIds        String?
  categoryIds       String?
  isActive          Boolean          @default(true)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  usages            PromoCodeUsage[]

  @@index([code])
  @@index([isActive])
  @@index([createdAt])
  @@index([updatedAt])
}

model PromoCodeUsage {
  id          String    @id @default(cuid())
  promoCodeId String
  userId      String
  orderId     String?
  discount    Decimal   @db.Decimal(10, 2)
  usedAt      DateTime  @default(now())
  promoCode   PromoCode @relation(fields: [promoCodeId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([promoCodeId])
  @@index([usedAt])
  @@index([userId])
}

model Purchase {
  id              String         @id @default(cuid())
  userId          String
  companyId       String?
  productId       String
  amount          Decimal        @db.Decimal(10, 2)
  currency        String         @default("CAD")
  paymentMethod   PaymentMethod
  stripePaymentId String?
  stripeInvoiceId String?
  paypalOrderId   String?
  status          PurchaseStatus @default(PENDING)
  receiptUrl      String?
  receiptNumber   String?        @unique
  idempotencyKey  String?        @unique
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  courseAccess    CourseAccess?
  company         Company?       @relation(fields: [companyId], references: [id])
  product         Product        @relation(fields: [productId], references: [id], onDelete: Restrict)
  user            User           @relation(fields: [userId], references: [id], onDelete: Restrict)
  shipping        Shipping?

  @@index([companyId])
  @@index([productId])
  @@index([status])
  @@index([userId])
  @@index([createdAt])
  @@index([updatedAt])
}

model PurchaseOrder {
  id                String              @id @default(cuid())
  poNumber          String              @unique
  supplierId        String?
  supplierName      String
  supplierEmail     String?
  department        String              @default("OPS")
  status            String              @default("DRAFT")
  requestedBy       String?
  approvedBy        String?
  approvedAt        DateTime?
  subtotal          Decimal             @default(0) @db.Decimal(12, 2)
  taxTps            Decimal             @default(0) @db.Decimal(12, 2)
  taxTvq            Decimal             @default(0) @db.Decimal(12, 2)
  total             Decimal             @default(0) @db.Decimal(12, 2)
  currency          String              @default("CAD")
  notes             String?
  supplierInvoiceId String?
  orderedAt         DateTime?
  receivedAt        DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  items             PurchaseOrderItem[]

  @@index([approvedBy])
  @@index([department])
  @@index([requestedBy])
  @@index([status])
  @@index([supplierInvoiceId])
  @@index([supplierId])
  @@index([createdAt])
  @@index([updatedAt])
}

model PurchaseOrderItem {
  id              String        @id @default(cuid())
  purchaseOrderId String
  description     String
  productId       String?
  formatId        String?
  sku             String?
  quantity        Int
  unitCost        Decimal       @db.Decimal(12, 2)
  total           Decimal       @db.Decimal(12, 2)
  receivedQty     Int           @default(0)
  createdAt       DateTime      @default(now())
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@index([formatId])
  @@index([productId])
  @@index([purchaseOrderId])
  @@index([createdAt])
}

model QuantityDiscount {
  id        String   @id @default(cuid())
  productId String
  minQty    Int
  maxQty    Int?
  discount  Decimal  @db.Decimal(5, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, minQty])
  @@index([productId])
  @@index([createdAt])
  @@index([updatedAt])
}

model QuickReply {
  id           String                  @id @default(cuid())
  title        String
  content      String
  category     String?
  sortOrder    Int                     @default(0)
  isActive     Boolean                 @default(true)
  createdAt    DateTime                @default(now())
  updatedAt    DateTime                @updatedAt
  translations QuickReplyTranslation[]

  @@index([category])
  @@index([createdAt])
  @@index([updatedAt])
}

model QuickReplyTranslation {
  id           String             @id @default(cuid())
  quickReplyId String
  locale       String
  title        String?
  content      String?
  contentHash  String?
  translatedBy String?            @default("gpt-4o-mini")
  isApproved   Boolean            @default(false)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  qualityLevel TranslationQuality @default(draft)
  quickReply   QuickReply         @relation(fields: [quickReplyId], references: [id], onDelete: Cascade)

  @@unique([quickReplyId, locale])
  @@index([locale])
  @@index([quickReplyId])
  @@index([createdAt])
  @@index([updatedAt])
}

model Referral {
  id            String    @id @default(cuid())
  referrerId    String
  referredId    String
  referralCode  String
  status        ReferralStatus @default(PENDING)
  orderAmount   Decimal?  @db.Decimal(10, 2)
  pointsAwarded Int       @default(0)
  discountGiven Decimal?  @db.Decimal(10, 2)
  qualifiedAt   DateTime?
  rewardedAt    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  referred      User      @relation("Referral_referredIdToUser", fields: [referredId], references: [id], onDelete: Restrict)
  referrer      User      @relation("Referral_referrerIdToUser", fields: [referrerId], references: [id], onDelete: Restrict)

  @@index([referralCode])
  @@index([referredId])
  @@index([referrerId])
  @@index([createdAt])
  @@index([updatedAt])
}

model ReturnRequest {
  id          String   @id @default(cuid())
  orderItemId String
  orderId     String
  userId      String
  reason      String
  details     String?
  status      String   @default("PENDING")
  resolution  String?
  adminNotes  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Restrict)
  user        User     @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@index([orderItemId])
  @@index([orderId])
  @@index([status])
  @@index([userId])
  @@index([createdAt])
  @@index([updatedAt])
}

model Refund {
  id              String    @id @default(cuid())
  orderId         String
  returnRequestId String?
  amount          Decimal   @db.Decimal(10, 2)
  status          String    @default("PENDING")
  reason          String
  processedAt     DateTime?
  processedBy     String?
  stripeRefundId  String?
  paypalRefundId  String?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([orderId])
  @@index([returnRequestId])
  @@index([status])
  @@index([createdAt])
  @@index([updatedAt])
}

model Review {
  id           String        @id @default(cuid())
  userId       String
  productId    String
  rating       Int
  title        String?
  comment      String?
  isVerified   Boolean       @default(false)
  isApproved   Boolean       @default(false)
  isPublished  Boolean       @default(false)
  reply        String?
  repliedAt    DateTime?
  helpfulCount Int           @default(0)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  product      Product       @relation(fields: [productId], references: [id], onDelete: Restrict)
  user         User          @relation(fields: [userId], references: [id], onDelete: Restrict)
  images       ReviewImage[]

  @@index([isApproved])
  @@index([productId])
  @@index([userId])
  @@index([productId, isApproved, isPublished])
  @@index([createdAt])
  @@index([updatedAt])
}

model ReviewImage {
  id        String   @id @default(cuid())
  reviewId  String
  url       String
  alt       String?
  order     Int      @default(0)
  createdAt DateTime @default(now())
  review    Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@index([reviewId])
  @@index([createdAt])
}

model SavedCard {
  id                    String   @id @default(cuid())
  userId                String
  stripePaymentMethodId String   @unique
  brand                 String
  last4                 String
  expMonth              Int
  expYear               Int
  isDefault             Boolean  @default(false)
  createdAt             DateTime @default(now())
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Shipping {
  id                String                  @id @default(cuid())
  purchaseId        String                  @unique
  recipientName     String
  addressLine1      String
  addressLine2      String?
  city              String
  state             String
  postalCode        String
  country           String                  @default("CA")
  phone             String?
  carrier           String?
  trackingNumber    String?
  trackingUrl       String?
  status            ShippingStatus          @default(PENDING)
  shippedAt         DateTime?
  estimatedDelivery DateTime?
  deliveredAt       DateTime?
  instructions      String?
  signature         Boolean                 @default(false)
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
  purchase          Purchase                @relation(fields: [purchaseId], references: [id], onDelete: Restrict)
  statusHistory     ShippingStatusHistory[]

  @@index([status])
  @@index([trackingNumber])
  @@index([createdAt])
  @@index([updatedAt])
}

model ShippingStatusHistory {
  id          String         @id @default(cuid())
  shippingId  String
  status      ShippingStatus
  location    String?
  description String?
  createdAt   DateTime       @default(now())
  shipping    Shipping       @relation(fields: [shippingId], references: [id], onDelete: Cascade)

  @@index([shippingId])
  @@index([createdAt])
}

model ShippingZone {
  id                    String   @id @default(cuid())
  name                  String
  countries             String
  baseFee               Decimal  @db.Decimal(10, 2)
  perItemFee            Decimal  @default(0) @db.Decimal(10, 2)
  freeShippingThreshold Decimal? @db.Decimal(10, 2)
  estimatedDaysMin      Int      @default(3)
  estimatedDaysMax      Int      @default(7)
  maxWeight             Decimal? @db.Decimal(10, 3)
  isActive              Boolean  @default(true)
  notes                 String?
  sortOrder             Int      @default(0)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([isActive])
  @@index([createdAt])
  @@index([updatedAt])
}

model SiteSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  type        String   @default("text")
  module      String   @default("general")
  description String?
  updatedBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([module])
  @@index([createdAt])
  @@index([updatedAt])
}

model SiteSettings {
  id                    String   @id @default("default")
  companyName           String   @default("BioCycle Peptides")
  companyLegalName      String?
  companyDescription    String?
  logoUrl               String?
  email                 String?
  supportEmail          String?
  legalEmail            String?
  privacyEmail          String?
  phone                 String?
  address               String?
  city                  String?
  province              String?
  postalCode            String?
  country               String?  @default("CA")
  businessHours         String?
  socialLinks           String?
  freeShippingThreshold Decimal? @db.Decimal(10, 2)
  defaultCurrency       String   @default("CAD")
  newsletterEnabled     Boolean  @default(true)
  newsletterTitle       String?
  newsletterSubtitle    String?
  newsletterDiscount    Int?
  newsletterPromoCode   String?
  disclaimerEnabled     Boolean  @default(true)
  disclaimerTitle       String?
  disclaimerContent     String?
  disclaimerAgeMin      Int      @default(18)
  cookieBannerText      String?
  trustBadges           String?
  headerNav             String?
  footerNav             String?
  shippingRates         String?
  refundDays            Int      @default(30)
  refundProcessingDays  String?
  ambassadorTiers       String?
  rewardTiers           String?
  subscriptionFreqs     String?
  testimonials          String?
  statsJson             String?
  updatedAt             DateTime @updatedAt
  @@index([updatedAt])
}

model StockAlert {
  id         String    @id @default(cuid())
  email      String
  productId  String
  formatId   String?
  notified   Boolean   @default(false)
  notifiedAt DateTime?
  createdAt  DateTime  @default(now())
  product    Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([email, productId, formatId])
  @@index([email])
  @@index([productId, notified])
  @@index([createdAt])
}

model Subscription {
  id              String    @id @default(cuid())
  userId          String
  productId       String
  formatId        String?
  productName     String
  formatName      String?
  quantity        Int       @default(1)
  frequency       String    @default("MONTHLY")
  discountPercent Int       @default(10)
  unitPrice       Decimal   @db.Decimal(10, 2)
  status          String    @default("ACTIVE")
  nextDelivery    DateTime
  lastDelivery    DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  cancelledAt     DateTime?

  @@index([formatId])
  @@index([nextDelivery])
  @@index([productId])
  @@index([status])
  @@index([userId])
  @@index([createdAt])
  @@index([updatedAt])
}

model SupplierInvoice {
  id              String        @id @default(cuid())
  invoiceNumber   String        @unique
  supplierId      String?
  supplierName    String
  supplierEmail   String?
  subtotal        Decimal       @db.Decimal(12, 2)
  taxTps          Decimal       @default(0) @db.Decimal(12, 2)
  taxTvq          Decimal       @default(0) @db.Decimal(12, 2)
  taxOther        Decimal       @default(0) @db.Decimal(12, 2)
  total           Decimal       @db.Decimal(12, 2)
  amountPaid      Decimal       @default(0) @db.Decimal(12, 2)
  balance         Decimal       @db.Decimal(12, 2)
  currency        String        @default("CAD")
  invoiceDate     DateTime
  dueDate         DateTime
  paidAt          DateTime?
  status          InvoiceStatus @default(DRAFT)
  expenseCategory String?
  documentUrl     String?
  notes           String?
  journalEntryId  String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  deletedAt       DateTime?

  @@index([dueDate])
  @@index([invoiceDate])
  @@index([journalEntryId])
  @@index([status])
  @@index([supplierId])
  @@index([deletedAt])
  @@index([status, invoiceDate]) // S10: Composite for tax-summary & gst-qst-declaration queries
  @@index([status, deletedAt]) // S10: Composite for active invoice queries (aging, filtering)
  @@index([supplierId, status]) // S10: Composite for supplier invoice listing with status filter
  @@index([createdAt])
  @@index([updatedAt])
}

model TaxReport {
  id                String          @id @default(cuid())
  period            String
  periodType        String          @default("MONTHLY")
  year              Int
  month             Int?
  quarter           Int?
  region            String
  regionCode        String
  tpsCollected      Decimal         @default(0) @db.Decimal(12, 2)
  tvqCollected      Decimal         @default(0) @db.Decimal(12, 2)
  tvhCollected      Decimal         @default(0) @db.Decimal(12, 2)
  otherTaxCollected Decimal         @default(0) @db.Decimal(12, 2)
  tpsPaid           Decimal         @default(0) @db.Decimal(12, 2)
  tvqPaid           Decimal         @default(0) @db.Decimal(12, 2)
  tvhPaid           Decimal         @default(0) @db.Decimal(12, 2)
  otherTaxPaid      Decimal         @default(0) @db.Decimal(12, 2)
  netTps            Decimal         @default(0) @db.Decimal(12, 2)
  netTvq            Decimal         @default(0) @db.Decimal(12, 2)
  netTvh            Decimal         @default(0) @db.Decimal(12, 2)
  netTotal          Decimal         @default(0) @db.Decimal(12, 2)
  salesCount        Int             @default(0)
  totalSales        Decimal         @default(0) @db.Decimal(12, 2)
  status            TaxReportStatus @default(DRAFT)
  generatedAt       DateTime        @default(now())
  filedAt           DateTime?
  paidAt            DateTime?
  dueDate           DateTime
  filingNumber      String?
  pdfUrl            String?
  notes             String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  //   Currently TaxReport has no updatedAt, making it impossible to track when reports are modified.

  @@unique([regionCode, year, month])
  @@index([status])
  @@index([year])
  @@index([year, regionCode]) // #58 - Composite index for tax report queries filtered by year+region
  @@index([createdAt])
  @@index([updatedAt])
}

model Testimonial {
  id            String                   @id @default(cuid())
  name          String
  role          String?
  company       String?
  content       String
  rating        Int                      @default(5)
  imageUrl      String?
  videoUrl      String?
  videoDuration String?
  locale        String                   @default("en")
  isPublished   Boolean                  @default(true)
  isFeatured    Boolean                  @default(false)
  sortOrder     Int                      @default(0)
  createdAt     DateTime                 @default(now())
  updatedAt     DateTime                 @updatedAt
  translations  TestimonialTranslation[]

  @@index([isPublished])
  @@index([locale])
  @@index([createdAt])
  @@index([updatedAt])
}

model TestimonialTranslation {
  id            String             @id @default(cuid())
  testimonialId String
  locale        String
  content       String?
  role          String?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  contentHash   String?
  translatedBy  String?            @default("gpt-4o-mini")
  isApproved    Boolean            @default(false)
  qualityLevel  TranslationQuality @default(draft)
  testimonial   Testimonial        @relation(fields: [testimonialId], references: [id], onDelete: Cascade)

  @@unique([testimonialId, locale])
  @@index([testimonialId])
  @@index([locale])
  @@index([createdAt])
  @@index([updatedAt])
}

model UatTestCase {
  id            String         @id @default(cuid())
  runId         String
  scenarioCode  String
  scenarioName  String
  region        String
  status        String         @default("PENDING")
  orderId       String?
  orderNumber   String?
  expectedTaxes Json?
  actualTaxes   Json?
  expectedTotal Decimal?       @db.Decimal(12, 2)
  actualTotal   Decimal?       @db.Decimal(12, 2)
  verifications Json?
  durationMs    Int?
  startedAt     DateTime?
  completedAt   DateTime?
  createdAt     DateTime       @default(now())
  run           UatTestRun     @relation(fields: [runId], references: [id], onDelete: Cascade)
  errors        UatTestError[]

  @@index([runId])
  @@index([scenarioCode])
  @@index([orderId])
  @@index([createdAt])
}

model UatTestError {
  id         String      @id @default(cuid())
  testCaseId String
  category   String
  severity   String      @default("ERROR")
  message    String
  expected   String?
  actual     String?
  context    Json?
  stackTrace String?
  createdAt  DateTime    @default(now())
  testCase   UatTestCase @relation(fields: [testCaseId], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([testCaseId])
  @@index([createdAt])
}

model UatTestRun {
  id             String        @id @default(cuid())
  runNumber      Int           @unique @default(autoincrement())
  status         String        @default("RUNNING")
  canadaOnly     Boolean       @default(true)
  totalScenarios Int           @default(0)
  passedCount    Int           @default(0)
  failedCount    Int           @default(0)
  skippedCount   Int           @default(0)
  startedAt      DateTime      @default(now())
  completedAt    DateTime?
  durationMs     Int?
  cleanedUp      Boolean       @default(false)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  testCases      UatTestCase[]
  @@index([createdAt])
  @@index([updatedAt])
}

model User {
  id                     String                  @id @default(cuid())
  email                  String                  @unique
  emailVerified          DateTime?
  name                   String?
  image                  String?
  password               String?
  role                   UserRole                @default(CUSTOMER)
  mfaEnabled             Boolean                 @default(false)
  mfaSecret              String?
  mfaBackupCodes         String?
  locale                 String                  @default("fr")
  timezone               String                  @default("America/Toronto")
  stripeCustomerId       String?                 @unique
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  birthDate              DateTime?
  lastBirthdayEmail      DateTime?
  lifetimePoints         Int                     @default(0)
  loyaltyPoints          Int                     @default(0)
  loyaltyTier            String                  @default("BRONZE")
  phone                  String?
  referralCode           String?                 @unique
  referredById           String?
  resetToken             String?
  resetTokenExpiry       DateTime?
  accounts               Account[]
  ambassadors            Ambassador[]
  company                Company?
  companyCustomers       CompanyCustomer[]
  assignedConversations  Conversation[]          @relation("Conversation_assignedToIdToUser")
  conversations          Conversation[]          @relation("Conversation_userIdToUser")
  courseAccesses         CourseAccess[]
  purchasedGiftCards     GiftCard[]              @relation("GiftCard_purchaserIdToUser")
  redeemedGiftCards      GiftCard[]              @relation("GiftCard_redeemedByToUser")
  grades                 Grade[]
  loyaltyTransactions    LoyaltyTransaction[]
  messages               Message[]
  notificationPreference NotificationPreference?
  passwordHistory        PasswordHistory[]
  priceWatches           PriceWatch[]
  productQuestions       ProductQuestion[]
  purchases              Purchase[]
  referralsReceived      Referral[]              @relation("Referral_referredIdToUser")
  referralsMade          Referral[]              @relation("Referral_referrerIdToUser")
  returnRequests         ReturnRequest[]
  reviews                Review[]
  savedCards             SavedCard[]
  sessions               Session[]
  addresses              UserAddress[]
  wishlistCollections    WishlistCollection[]
  authenticators         Authenticator[]
  orders                 Order[]

  // Communication Hub relations
  customerConversations EmailConversation[] @relation("customerConversations")
  assignedEmailConvos   EmailConversation[] @relation("assignedConversations")
  outboundReplies       OutboundReply[]
  conversationNotes     ConversationNote[]
  consentRecords        ConsentRecord[]
  mailingListSubscriber MailingListSubscriber[] @relation("mailingListSubscriber")

  // Forum & Community relations
  forumPosts      ForumPost[]      @relation("ForumPostAuthor")
  forumReplies    ForumReply[]     @relation("ForumReplyAuthor")
  forumVotes      ForumVote[]
  contactMessages ContactMessage[] @relation("ContactMessageUser")

  // RGPD: Terms of Service & Privacy Policy acceptance proof
  termsAcceptedAt   DateTime?
  termsVersion      String?
  privacyAcceptedAt DateTime?

  @@index([role])
  @@index([createdAt])
  @@index([loyaltyTier])
  @@index([referredById])
  @@index([updatedAt])
}

model Authenticator {
  credentialID         String    @unique
  userId               String
  providerAccountId    String    @default("")
  credentialPublicKey  String
  counter              Int
  credentialDeviceType String
  credentialBackedUp   Boolean
  transports           String?
  deviceName           String?
  createdAt            DateTime  @default(now())
  lastUsedAt           DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, credentialID])
  @@index([userId])
  @@index([createdAt])
}

model UserAddress {
  id            String   @id @default(cuid())
  userId        String
  label         String?
  recipientName String
  addressLine1  String
  addressLine2  String?
  city          String
  state         String
  postalCode    String
  country       String   @default("CA")
  phone         String?
  isDefault     Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([updatedAt])
}

model UserPermissionGroup {
  id         String          @id @default(cuid())
  userId     String
  groupId    String
  assignedBy String?
  assignedAt DateTime        @default(now())
  group      PermissionGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([userId, groupId])
  @@index([groupId])
  @@index([userId])
}

model UserPermissionOverride {
  id             String    @id @default(cuid())
  userId         String
  permissionCode String
  granted        Boolean
  reason         String?
  grantedBy      String
  expiresAt      DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@unique([userId, permissionCode])
  @@index([permissionCode])
  @@index([userId])
  @@index([createdAt])
  @@index([updatedAt])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Video {
  id           String             @id @default(cuid())
  title        String
  slug         String             @unique
  description  String?
  thumbnailUrl String?
  videoUrl     String?
  duration     String?
  category     String?
  tags         String?
  instructor   String?
  views        Int                @default(0)
  isFeatured   Boolean            @default(false)
  isPublished  Boolean            @default(false)
  locale       String             @default("en")
  sortOrder    Int                @default(0)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  translations VideoTranslation[]

  @@index([category])
  @@index([isPublished])
  @@index([slug])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([title])    // F-57: Text search on video title
}

model VideoTranslation {
  id           String             @id @default(cuid())
  videoId      String
  locale       String
  title        String?
  description  String?
  contentHash  String?
  translatedBy String?            @default("gpt-4o-mini")
  isApproved   Boolean            @default(false)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  qualityLevel TranslationQuality @default(draft)
  video        Video              @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([videoId, locale])
  @@index([locale])
  @@index([videoId])
  @@index([createdAt])
  @@index([updatedAt])
}

model WebhookEvent {
  id             String             @id @default(cuid())
  eventId        String             @unique
  provider       String
  eventType      String
  status         WebhookEventStatus @default(PROCESSING)
  orderId        String?
  journalEntryId String?
  payload        String?
  errorMessage   String?
  processedAt    DateTime?
  createdAt      DateTime           @default(now())

  @@index([eventId])
  @@index([journalEntryId])
  @@index([orderId])
  @@index([provider])
  @@index([status])
  @@index([createdAt])
}

model Webinar {
  id              String               @id @default(cuid())
  title           String
  slug            String               @unique
  description     String?
  thumbnailUrl    String?
  speaker         String?
  speakerTitle    String?
  speakerImage    String?
  scheduledAt     DateTime?
  duration        Int?
  category        String?
  tags            String?
  registrationUrl String?
  recordingUrl    String?
  maxAttendees    Int?
  registeredCount Int                  @default(0)
  isFeatured      Boolean              @default(false)
  isPublished     Boolean              @default(false)
  isLive          Boolean              @default(false)
  locale          String               @default("en")
  sortOrder       Int                  @default(0)
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  translations    WebinarTranslation[]

  @@index([isPublished])
  @@index([scheduledAt])
  @@index([slug])
  @@index([createdAt])
  @@index([updatedAt])
}

model WebinarTranslation {
  id           String             @id @default(cuid())
  webinarId    String
  locale       String
  title        String?
  description  String?
  speakerTitle String?
  contentHash  String?
  translatedBy String?            @default("gpt-4o-mini")
  isApproved   Boolean            @default(false)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  qualityLevel TranslationQuality @default(draft)
  webinar      Webinar            @relation(fields: [webinarId], references: [id], onDelete: Cascade)

  @@unique([webinarId, locale])
  @@index([locale])
  @@index([webinarId])
  @@index([createdAt])
  @@index([updatedAt])
}

model Wishlist {
  id        String   @id @default(cuid())
  userId    String
  productId String
  createdAt DateTime @default(now())

  @@unique([userId, productId])
  @@index([productId])
  @@index([userId])
  @@index([createdAt])
}

model WishlistCollection {
  id        String         @id @default(cuid())
  userId    String
  name      String         @default("My Wishlist")
  isDefault Boolean        @default(false)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     WishlistItem[]

  @@index([userId])
  @@index([createdAt])
  @@index([updatedAt])
}

model WishlistItem {
  id           String             @id @default(cuid())
  collectionId String
  productId    String
  createdAt    DateTime           @default(now())
  collection   WishlistCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  @@unique([collectionId, productId])
  @@index([collectionId])
  @@index([productId])
  @@index([createdAt])
}

model TranslationJob {
  id          String               @id @default(cuid())
  model       String
  entityId    String
  pass        Int                  @default(1)
  priority    Int                  @default(3)
  status      TranslationJobStatus @default(pending)
  retries     Int                  @default(0)
  maxRetries  Int                  @default(3)
  error       String?
  scheduledAt DateTime             @default(now())
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  @@unique([model, entityId, pass, status])
  @@index([status, priority, scheduledAt])
  @@index([model, entityId])
  @@index([createdAt])
  @@index([updatedAt])
}

enum TranslationQuality {
  draft
  improved
  verified
  human
}

enum TranslationJobStatus {
  pending
  processing
  completed
  failed
}

model TranslationFeedback {
  id        String   @id @default(cuid())
  locale    String
  rating    String // 'good' | 'bad'
  comment   String?
  page      String
  userAgent String?
  createdAt DateTime @default(now())

  @@index([locale, rating])
  @@index([createdAt])
}

model UpsellConfig {
  id                   String   @id @default(cuid())
  productId            String?  @unique
  isEnabled            Boolean  @default(true)
  showQuantityDiscount Boolean  @default(true)
  showSubscription     Boolean  @default(true)
  displayRule          String   @default("ALWAYS")
  quantityTitle        String?
  quantitySubtitle     String?
  subscriptionTitle    String?
  subscriptionSubtitle String?
  suggestedQuantity    Int?
  suggestedFrequency   String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  product              Product? @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([isEnabled])
  @@index([createdAt])
  @@index([updatedAt])
}

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

enum ChatSender {
  VISITOR
  ADMIN
  BOT
}

enum ChatMessageType {
  TEXT
  IMAGE
  FILE
}

enum ChatStatus {
  ACTIVE
  WAITING_ADMIN
  CLOSED
  ARCHIVED
}

enum ConversationStatus {
  OPEN
  PENDING
  RESOLVED
  CLOSED
}

enum CreditNoteStatus {
  DRAFT
  ISSUED
  APPLIED
  VOID
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum ExpenseStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  REIMBURSED
}

enum FormatType {
  VIAL_2ML
  VIAL_10ML
  CARTRIDGE_3ML
  KIT_12
  CAPSULE_60
  CAPSULE_120
  PACK_5
  PACK_10
  BUNDLE
  ACCESSORY
  NASAL_SPRAY
  CREAM
}

enum HeroMediaType {
  IMAGE
  VIDEO
  ANIMATION
}

enum InventoryReservationStatus {
  RESERVED
  RELEASED
  CONSUMED
}

enum InventoryTransactionType {
  PURCHASE
  SALE
  ADJUSTMENT
  RETURN
  LOSS
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  PARTIAL
  OVERDUE
  CANCELLED
  VOID
}

enum JournalEntryStatus {
  DRAFT
  POSTED
  VOIDED
}

enum JournalEntryType {
  MANUAL
  AUTO_SALE
  AUTO_REFUND
  AUTO_STRIPE_FEE
  AUTO_PAYPAL_FEE
  AUTO_SHIPPING
  AUTO_PURCHASE
  RECURRING
  ADJUSTMENT
  CLOSING
}

enum LoyaltyTransactionType {
  EARN_PURCHASE
  EARN_REFERRAL
  EARN_REVIEW
  EARN_SIGNUP
  EARN_BIRTHDAY
  EARN_BONUS
  REDEEM_DISCOUNT
  REDEEM_PRODUCT
  EXPIRE
  ADJUST
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  SYSTEM
}

enum PaymentMethod {
  STRIPE_CARD
  APPLE_PAY
  GOOGLE_PAY
  PAYPAL
  VISA_CLICK_TO_PAY
  MASTERCARD_CLICK_TO_PAY
  AURELIA_PAY
}

enum ProductType {
  PEPTIDE
  SUPPLEMENT
  ACCESSORY
  BUNDLE
  CAPSULE
  LAB_SUPPLY
}

enum PurchaseStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum ReconciliationStatus {
  PENDING
  MATCHED
  UNMATCHED
  MANUAL
}

enum ReferralStatus {
  PENDING
  QUALIFIED
  REWARDED
  EXPIRED
  CANCELLED
}

enum ShippingStatus {
  PENDING
  PROCESSING
  SHIPPED
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  FAILED
}

enum StockStatus {
  IN_STOCK
  OUT_OF_STOCK
  DISCONTINUED
  COMING_SOON
  PRE_ORDER
  LIMITED
}

enum TaxReportStatus {
  DRAFT
  GENERATED
  FILED
  PAID
}

enum UserRole {
  PUBLIC
  CUSTOMER
  CLIENT
  EMPLOYEE
  OWNER
}

enum WebhookEventStatus {
  PROCESSING
  COMPLETED
  FAILED
}

// =====================================================
// SEARCH (Improvements 56-65)
// =====================================================

model SearchLog {
  id          String   @id @default(cuid())
  query       String
  resultCount Int      @default(0)
  userId      String?
  filters     Json?
  locale      String?
  duration    Int? // ms
  createdAt   DateTime @default(now())

  @@index([query])
  @@index([createdAt])
  @@index([userId])
}

// =====================================================
// WEBHOOKS (Improvements 76-82)
// =====================================================

model WebhookEndpoint {
  id         String            @id @default(cuid())
  url        String
  events     String[]
  secret     String
  active     Boolean           @default(true)
  name       String?
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  deliveries WebhookDelivery[]

  @@index([active])
  @@index([createdAt])
  @@index([updatedAt])
}

model WebhookDelivery {
  id          String          @id @default(cuid())
  endpointId  String
  event       String
  payload     Json
  status      Int             @default(0) // HTTP status code, 0 = pending
  attempts    Int             @default(0)
  lastAttempt DateTime?
  response    String?
  duration    Int? // ms
  createdAt   DateTime        @default(now())
  endpoint    WebhookEndpoint @relation(fields: [endpointId], references: [id], onDelete: Cascade)

  @@index([endpointId])
  @@index([event])
  @@index([status])
  @@index([createdAt])
}

enum WebhookDeliveryStatus {
  PENDING
  SUCCESS
  FAILED
  RETRYING
}

// =====================================================
// PHASE 4 COMPLIANCE: Audit Trail + Recurring Templates
// =====================================================

model AuditTrail {
  id         String   @id @default(cuid())
  entityType String // e.g. "JournalEntry", "CustomerInvoice", "CreditNote"
  entityId   String
  action     String // CREATE, UPDATE, DELETE, POST, VOID, etc.
  field      String? // specific field changed (null for create/delete)
  oldValue   String? // previous value (JSON string for complex types)
  newValue   String? // new value
  userId     String // who made the change
  userName   String? // cached display name
  ipAddress  String?
  userAgent  String?
  metadata   Json? // additional context
  createdAt  DateTime @default(now())

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
  @@index([action]) // Phase 9: Index for action-based filtering
  @@index([action, createdAt]) // Phase 9: Composite for action + time range queries
}

model RecurringEntryTemplate {
  id           String    @id @default(cuid())
  name         String
  description  String?
  frequency    String // DAILY, WEEKLY, MONTHLY, QUARTERLY, YEARLY
  dayOfMonth   Int? // for MONTHLY
  dayOfWeek    Int? // for WEEKLY (0=Sun, 6=Sat)
  nextRunDate  DateTime
  lastRunDate  DateTime?
  isActive     Boolean   @default(true)
  templateData Json // { lines: [{accountId, debit, credit}], description, type }
  createdBy    String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([isActive, nextRunDate])
  @@index([frequency])
  @@index([createdAt])
  @@index([updatedAt])
}

// =============================================
// FIXED ASSETS / IMMOBILISATIONS (CCA)
// =============================================

model FixedAsset {
  id                      String                   @id @default(cuid())
  name                    String
  description             String?
  // Asset details
  assetNumber             String                   @unique // Internal tracking number (e.g. FA-001)
  serialNumber            String?
  location                String?
  // Financial
  acquisitionDate         DateTime
  acquisitionCost         Decimal                  @db.Decimal(12, 2)
  residualValue           Decimal                  @default(0) @db.Decimal(12, 2)
  currentBookValue        Decimal                  @db.Decimal(12, 2) // Updated after each depreciation
  accumulatedDepreciation Decimal                  @default(0) @db.Decimal(12, 2)
  // CCA (Capital Cost Allowance)
  ccaClass                Int // CCA class number (8, 10, 12, 13, 14.1, 50, etc.)
  ccaRate                 Decimal @db.Decimal(5, 4) // F-008: CCA rate (was Float, now Decimal for tax precision)
  depreciationMethod      String                   @default("DECLINING_BALANCE") // DECLINING_BALANCE, STRAIGHT_LINE, LEASE_TERM
  halfYearRuleApplied     Boolean                  @default(true) // Half-year rule for first year
  aiiApplied              Boolean                  @default(false) // Accelerated Investment Incentive (1.5x first year)
  superDeduction          Boolean                  @default(false) // 100% immediate expensing (Budget 2025)
  // GIFI
  gifiCode                String? // GIFI code for this asset category
  // Status
  status                  String                   @default("ACTIVE") // ACTIVE, DISPOSED, FULLY_DEPRECIATED, WRITTEN_OFF
  disposalDate            DateTime?
  disposalProceeds        Decimal?                 @db.Decimal(12, 2)
  disposalGainLoss        Decimal?                 @db.Decimal(12, 2)
  // Linked accounts
  assetAccountId          String // Balance sheet asset account
  depreciationAccountId   String // Accumulated depreciation contra account
  expenseAccountId        String // Depreciation expense account
  assetAccount            ChartOfAccount           @relation("AssetAccount", fields: [assetAccountId], references: [id], onDelete: Restrict)
  depreciationAccount     ChartOfAccount           @relation("DepreciationAccount", fields: [depreciationAccountId], references: [id], onDelete: Restrict)
  expenseAccount          ChartOfAccount           @relation("ExpenseAccount", fields: [expenseAccountId], references: [id], onDelete: Restrict)
  // Metadata
  notes                   String?
  attachments             Json? // Array of file references
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  depreciationEntries     FixedAssetDepreciation[]

  @@index([ccaClass])
  @@index([depreciationAccountId])
  @@index([expenseAccountId])
  @@index([status])
  @@index([assetAccountId])
  @@index([acquisitionDate])
  @@index([createdAt])
  @@index([updatedAt])
}

model FixedAssetDepreciation {
  id             String     @id @default(cuid())
  fixedAssetId   String
  fixedAsset     FixedAsset @relation(fields: [fixedAssetId], references: [id], onDelete: Cascade)
  // Period
  fiscalYear     Int // e.g. 2026
  periodStart    DateTime
  periodEnd      DateTime
  // Amounts
  openingUCC     Decimal    @db.Decimal(12, 2) // Undepreciated Capital Cost at start
  ccaClaimed     Decimal    @db.Decimal(12, 2) // CCA claimed this period
  closingUCC     Decimal    @db.Decimal(12, 2) // UCC at end of period
  // Journal entry reference
  journalEntryId String?
  // Metadata
  notes          String?
  createdAt      DateTime   @default(now())

  @@unique([fixedAssetId, fiscalYear])
  @@index([fiscalYear])
  @@index([journalEntryId])
  @@index([createdAt])
}

// =============================================
// FISCAL CALENDAR / CALENDRIER FISCAL
// =============================================

model FiscalCalendarEvent {
  id            String    @id @default(cuid())
  // Event details
  title         String
  titleFr       String?
  description   String?
  descriptionFr String?
  // Scheduling
  dueDate       DateTime
  reminderDate  DateTime? // When to send reminder
  // Classification
  category      String // payroll, corporate_tax, sales_tax, information_return, installment
  authority     String // CRA, RQ, BOTH, SERVICE_CANADA
  frequency     String // once, monthly, quarterly, annual
  // Status
  status        String    @default("PENDING") // PENDING, COMPLETED, OVERDUE, SKIPPED
  completedAt   DateTime?
  completedBy   String?
  // Amount (for installments/remittances)
  amount        Decimal?  @db.Decimal(12, 2)
  // Recurrence (for auto-generated events)
  isRecurring   Boolean   @default(false)
  templateId    String? // Reference to the deadline template
  // Metadata
  notes         String?
  attachments   Json?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([dueDate])
  @@index([status])
  @@index([category])
  @@index([authority])
  @@index([templateId])
  @@index([createdAt])
  @@index([updatedAt])
}

// =============================================
// DOCUMENT ATTACHMENTS (for all transactions)
// =============================================

model DocumentAttachment {
  id           String   @id @default(cuid())
  // Entity reference (polymorphic)
  entityType   String // journal_entry, customer_invoice, supplier_invoice, expense, fixed_asset, etc.
  entityId     String
  // File details
  fileName     String
  fileType     String // pdf, jpg, png, etc.
  fileSize     Int // bytes
  fileUrl      String // Storage URL (e.g. Cloudinary, S3)
  thumbnailUrl String? // Preview thumbnail
  // Metadata
  description  String?
  uploadedBy   String?
  createdAt    DateTime @default(now())

  @@index([entityType, entityId])
  @@index([createdAt])
}

// =============================================
// BANK RULES (auto-categorization)
// =============================================

model BankRule {
  id       String  @id @default(cuid())
  name     String
  priority Int     @default(0)
  isActive Boolean @default(true)

  // Conditions (all optional - multiple conditions = AND logic)
  descriptionContains   String?
  descriptionStartsWith String?
  descriptionExact      String?
  amountMin             Decimal? @db.Decimal(12, 2)
  amountMax             Decimal? @db.Decimal(12, 2)
  amountExact           Decimal? @db.Decimal(12, 2)
  transactionType       String? // DEBIT, CREDIT

  // Actions
  accountId   String?
  account     ChartOfAccount? @relation("bankRuleAccount", fields: [accountId], references: [id])
  categoryTag String?
  taxCode     String? // GST, QST, HST, EXEMPT, ZERO_RATED
  description String? // Override description

  // Stats
  timesApplied  Int       @default(0)
  lastAppliedAt DateTime?

  createdBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive, priority])
  @@index([accountId])
  @@index([createdAt])
  @@index([updatedAt])
}

// =============================================
// COMMUNICATION HUB - Unified Email/Notification System
// =============================================

model InboundEmail {
  id             String                   @id @default(cuid())
  conversationId String?
  from           String
  fromName       String?
  to             String
  subject        String
  htmlBody       String?
  textBody       String?
  messageId      String                   @unique
  inReplyTo      String?
  references     String?
  isSpam         Boolean                  @default(false)
  spamScore      Float?
  receivedAt     DateTime                 @default(now())
  conversation   EmailConversation?       @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  attachments    InboundEmailAttachment[]

  @@index([from])
  @@index([conversationId])
  @@index([messageId])
  @@index([receivedAt])
}

model InboundEmailAttachment {
  id             String       @id @default(cuid())
  inboundEmailId String
  filename       String
  mimeType       String
  size           Int
  storageUrl     String
  inboundEmail   InboundEmail @relation(fields: [inboundEmailId], references: [id], onDelete: Cascade)

  @@index([inboundEmailId])
}

model EmailConversation {
  id              String                 @id @default(cuid())
  subject         String
  customerId      String?
  assignedToId    String?
  status          String                 @default("NEW")
  priority        String                 @default("NORMAL")
  tags            String?
  slaDeadline     DateTime?
  snoozedUntil    DateTime?
  lastMessageAt   DateTime               @default(now())
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  customer        User?                  @relation("customerConversations", fields: [customerId], references: [id], onDelete: SetNull)
  assignedTo      User?                  @relation("assignedConversations", fields: [assignedToId], references: [id], onDelete: SetNull)
  inboundEmails   InboundEmail[]
  outboundReplies OutboundReply[]
  notes           ConversationNote[]
  activities      ConversationActivity[]

  @@index([customerId])
  @@index([assignedToId])
  @@index([status])
  @@index([lastMessageAt])
  @@index([snoozedUntil])
  @@index([createdAt])
  @@index([updatedAt])
}

model OutboundReply {
  id             String            @id @default(cuid())
  conversationId String
  senderId       String
  to             String
  subject        String
  htmlBody       String
  textBody       String?
  messageId      String?
  status         String            @default("sent")
  scheduledFor   DateTime?
  sentAt         DateTime?
  createdAt      DateTime          @default(now())
  conversation   EmailConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User              @relation(fields: [senderId], references: [id], onDelete: Restrict)

  @@index([conversationId])
  @@index([senderId])
  @@index([messageId])
  @@index([createdAt])
}

model ConversationNote {
  id             String            @id @default(cuid())
  conversationId String
  authorId       String
  content        String
  mentions       String?
  createdAt      DateTime          @default(now())
  conversation   EmailConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  author         User              @relation(fields: [authorId], references: [id], onDelete: Restrict)

  @@index([authorId])
  @@index([conversationId])
  @@index([createdAt])
}

model ConversationActivity {
  id             String            @id @default(cuid())
  conversationId String
  actorId        String?
  action         String
  details        String?
  createdAt      DateTime          @default(now())
  conversation   EmailConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([actorId])
  @@index([conversationId])
  @@index([createdAt])
}

model CannedResponse {
  id         String   @id @default(cuid())
  title      String
  content    String
  variables  String?
  category   String?
  locale     String   @default("fr")
  usageCount Int      @default(0)
  createdBy  String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([category])
  @@index([locale])
  @@index([createdAt])
  @@index([updatedAt])
}

model EmailAutomationFlow {
  id          String               @id @default(cuid())
  name        String
  description String?
  trigger     String
  nodes       String
  edges       String
  isActive    Boolean              @default(false)
  stats       String?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  executions  EmailFlowExecution[]

  @@index([trigger])
  @@index([isActive])
  @@index([createdAt])
  @@index([updatedAt])
}

model EmailCampaign {
  id           String    @id @default(cuid())
  name         String
  subject      String
  htmlContent  String
  textContent  String?
  segmentQuery String?
  status       String    @default("DRAFT")
  scheduledAt  DateTime?
  sentAt       DateTime?
  stats        String?
  abTestConfig String?
  createdBy    String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([status])
  @@index([scheduledAt])
  @@index([createdAt])
  @@index([updatedAt])
}

model ConsentRecord {
  id             String    @id @default(cuid())
  email          String
  userId         String?
  type           String
  purpose        String?   // DB-009: MARKETING, ANALYTICS, PERSONALIZATION, THIRD_PARTY
  source         String
  consentText    String
  version        String?   // DB-009: Policy version consented to
  grantedAt      DateTime  @default(now())
  expiresAt      DateTime?
  revokedAt      DateTime?
  ipAddress      String?
  userAgent      String?   // DB-009: Browser/device info at consent time
  lawfulBasis    String?   // DB-009: CONSENT, LEGITIMATE_INTEREST, CONTRACT
  user           User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([userId])
  @@index([type])
  @@index([email, type]) // FLAW-069: Composite for consent queries
  @@index([purpose])
  @@index([grantedAt])
  @@index([revokedAt])
}

// ── Email Settings & Segments ────────────────────────────────────

model EmailSettings {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt
  @@index([updatedAt])
}

model EmailSegment {
  id          String   @id @default(cuid())
  name        String
  description String?
  query       String   // JSON: segment filter criteria
  color       String?
  contactCount Int     @default(0)
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([createdBy])
  @@index([createdAt])
  @@index([updatedAt])
}

model EmailFlowExecution {
  id          String               @id @default(cuid())
  flowId      String
  email       String
  currentNode String
  context     String               // JSON: execution context
  status      String               @default("WAITING") // WAITING, RUNNING, COMPLETED, FAILED, CANCELLED
  executeAt   DateTime
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  flow        EmailAutomationFlow  @relation(fields: [flowId], references: [id], onDelete: Cascade)

  @@index([status, executeAt])
  @@index([flowId])
  @@index([email])
  @@index([createdAt])
  @@index([updatedAt])
}

// ── Admin Navigation (Web Navigator) ────────────────────────────

model AdminNavSection {
  id          String              @id @default(cuid())
  railId      String
  title       String
  subtitle    String?
  icon        String?
  sortOrder   Int                 @default(0)
  isActive    Boolean             @default(true)
  subSections AdminNavSubSection[]
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  @@index([railId])
  @@index([sortOrder])
  @@index([createdAt])
  @@index([updatedAt])
}

model AdminNavSubSection {
  id        String           @id @default(cuid())
  sectionId String
  title     String
  subtitle  String?
  icon      String?
  sortOrder Int              @default(0)
  isActive  Boolean          @default(true)
  section   AdminNavSection  @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  pages     AdminNavPage[]
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@index([sectionId])
  @@index([sortOrder])
  @@index([createdAt])
  @@index([updatedAt])
}

model AdminNavPage {
  id           String              @id @default(cuid())
  subSectionId String
  title        String
  subtitle     String?
  url          String
  icon         String?
  sortOrder    Int                 @default(0)
  isActive     Boolean             @default(true)
  openInNewTab Boolean             @default(false)
  subSection   AdminNavSubSection  @relation(fields: [subSectionId], references: [id], onDelete: Cascade)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  @@index([subSectionId])
  @@index([sortOrder])
  @@index([createdAt])
  @@index([updatedAt])
}

model Supplier {
  id         String            @id @default(cuid())
  name       String
  code       String?           @unique
  email      String?           @unique
  phone      String?
  website    String?
  address    String?
  city       String?
  province   String?
  postalCode String?
  country    String?           @default("CA")
  notes      String?
  isActive   Boolean           @default(true)
  contacts   SupplierContact[]
  links      SupplierLink[]
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  @@index([name])
  @@index([isActive])
  @@index([createdAt])
  @@index([updatedAt])
}

model SupplierContact {
  id         String   @id @default(cuid())
  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  department String
  name       String
  email      String?
  phone      String?
  extension  String?
  title      String?
  isPrimary  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([supplierId])
  @@index([createdAt])
  @@index([updatedAt])
}

model SupplierLink {
  id         String   @id @default(cuid())
  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  label      String
  url        String
  type       String   @default("other")
  sortOrder  Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([supplierId])
  @@index([createdAt])
  @@index([updatedAt])
}

// ── CASL-Compliant Mailing List ─────────────────────────────────

model MailingListSubscriber {
  id               String                  @id @default(cuid())
  email            String                  @unique
  name             String?
  userId           String?
  user             User?                   @relation("mailingListSubscriber", fields: [userId], references: [id], onDelete: SetNull)
  status           MailingListStatus       @default(PENDING)
  consentType      ConsentType             @default(EXPRESS)
  consentDate      DateTime                @default(now())
  consentIp        String?
  consentMethod    String? // "website_form", "checkout", "account_settings"
  confirmToken     String?                 @unique
  confirmedAt      DateTime?
  unsubscribedAt   DateTime?
  unsubscribeToken String?                 @unique
  preferences      MailingListPreference[]
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt

  @@index([email])
  @@index([status])
  @@index([confirmToken])
  @@index([unsubscribeToken])
  @@index([userId])
  @@index([createdAt])
  @@index([updatedAt])
}

model MailingListPreference {
  id           String                @id @default(cuid())
  subscriberId String
  subscriber   MailingListSubscriber @relation(fields: [subscriberId], references: [id], onDelete: Cascade)
  category     String // "promotions", "promo_codes", "specials", "new_products"
  isEnabled    Boolean               @default(true)
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt

  @@unique([subscriberId, category])
  @@index([subscriberId])
  @@index([createdAt])
  @@index([updatedAt])
}

enum MailingListStatus {
  PENDING // Awaiting confirmation (double opt-in)
  ACTIVE // Confirmed and subscribed
  UNSUBSCRIBED
  BOUNCED
}

enum ConsentType {
  EXPRESS // Active opt-in (CASL required)
  IMPLIED // Existing business relationship (limited to 2 years)
}

// =============================================
// ACCOUNTING EXPORT
// =============================================

model AccountingExport {
  id          String   @id @default(cuid())
  name        String
  format      String   @default("CSV") // CSV, PDF, QBO, SAGE
  periodStart DateTime
  periodEnd   DateTime
  filters     String?  // JSON: { accountIds, types, statuses }
  fileUrl     String?
  fileSize    Int?
  status      String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  errorMsg    String?
  createdBy   String
  createdAt   DateTime @default(now())
  completedAt DateTime?

  @@index([status])
  @@index([createdBy])
  @@index([createdAt])
}

// =============================================
// OCR SCAN / DOCUMENT SCANNING
// =============================================

model OcrScan {
  id             String   @id @default(cuid())
  originalUrl    String
  originalName   String
  mimeType       String
  status         String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  extractedText  String?
  extractedData  String?  // JSON: { vendor, date, total, taxAmount, currency, lineItems }
  confidence     Float?
  journalEntryId String?
  errorMsg       String?
  createdBy      String
  createdAt      DateTime @default(now())
  processedAt    DateTime?

  @@index([status])
  @@index([createdBy])
  @@index([journalEntryId])
  @@index([createdAt])
}

// =============================================
// CODE AUDIT SYSTEM (25 audit types)
// =============================================

model AuditFunction {
  id            String         @id @default(cuid())
  name          String
  filePath      String
  type          String // api_handler, page, component, hook, lib, middleware
  description   String?
  exportType    String? // default, named, GET, POST, PUT, DELETE, PATCH
  relatedModels String? // JSON array of Prisma model names used
  relatedAPIs   String? // JSON array of API routes called
  linesOfCode   Int?
  status        String         @default("ACTIVE") // ACTIVE, DEPRECATED, REMOVED
  findings      AuditFinding[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@unique([filePath, name])
  @@index([type])
  @@index([status])
  @@index([filePath])
  @@index([createdAt])
  @@index([updatedAt])
}

model AuditType {
  id          String     @id @default(cuid())
  code        String     @unique // e.g. AUTH-SESSION, AUTHZ-RBAC
  name        String
  nameFr      String?
  description String
  descriptionFr String?
  severity    String // CRITICAL, HIGH, MEDIUM, LOW
  category    String // security, integrity, performance, quality, compliance
  checklist   String // JSON array of check items
  sortOrder   Int        @default(0)
  isActive    Boolean    @default(true)
  runs        AuditRun[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([severity])
  @@index([category])
  @@index([sortOrder])
  @@index([createdAt])
  @@index([updatedAt])
}

model AuditRun {
  id             String         @id @default(cuid())
  auditTypeId    String
  auditType      AuditType      @relation(fields: [auditTypeId], references: [id], onDelete: Cascade)
  status         String         @default("RUNNING") // RUNNING, COMPLETED, FAILED, CANCELLED
  startedAt      DateTime       @default(now())
  completedAt    DateTime?
  totalChecks    Int            @default(0)
  passedChecks   Int            @default(0)
  failedChecks   Int            @default(0)
  findingsCount  Int            @default(0)
  summary        String? // JSON summary of results
  runBy          String?
  durationMs     Int?
  findings       AuditFinding[]
  createdAt      DateTime       @default(now())

  @@index([auditTypeId])
  @@index([status])
  @@index([startedAt])
  @@index([createdAt])
}

model AuditFinding {
  id              String        @id @default(cuid())
  auditRunId      String
  auditRun        AuditRun      @relation(fields: [auditRunId], references: [id], onDelete: Cascade)
  functionId      String?
  function        AuditFunction? @relation(fields: [functionId], references: [id], onDelete: SetNull)
  checkId         String // which checklist item found this
  severity        String // CRITICAL, HIGH, MEDIUM, LOW, INFO
  title           String
  description     String
  filePath        String?
  lineNumber      Int?
  codeSnippet     String?
  recommendation  String?
  fixed           Boolean       @default(false)
  fixedAt         DateTime?
  fixedBy         String?
  fixCommit       String?
  falsePositive   Boolean       @default(false)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([auditRunId])
  @@index([functionId])
  @@index([severity])
  @@index([fixed])
  @@index([checkId])
  @@index([createdAt])
  @@index([updatedAt])
}

// =============================================
// MEGA-UPGRADE: NEW MODELS (2026-02-24)
// =============================================

// DB-001: Customer Metrics for CLV prediction, RFM segmentation, churn scoring
model CustomerMetrics {
  id               String   @id @default(cuid())
  userId           String   @unique
  predictedCLV     Decimal  @default(0) @db.Decimal(12, 2)
  rfmSegment       String   @default("NEW") // CHAMPIONS, LOYAL, AT_RISK, LOST, NEW, etc.
  churnScore       Decimal  @default(0) @db.Decimal(5, 4) // 0.0000 to 1.0000
  avgOrderValue    Decimal  @default(0) @db.Decimal(10, 2)
  orderFrequency   Decimal  @default(0) @db.Decimal(8, 2) // avg days between orders
  totalOrders      Int      @default(0)
  totalSpent       Decimal  @default(0) @db.Decimal(12, 2)
  lastOrderDays    Int      @default(0)
  firstOrderAt     DateTime?
  lastOrderAt      DateTime?
  recencyScore     Int      @default(0) // 1-5
  frequencyScore   Int      @default(0) // 1-5
  monetaryScore    Int      @default(0) // 1-5
  calculatedAt     DateTime @default(now())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([rfmSegment])
  @@index([churnScore])
  @@index([predictedCLV])
  @@index([calculatedAt])
  @@index([createdAt])
  @@index([updatedAt])
}

// DB-002: Abandoned Cart recovery
model AbandonedCart {
  id               String    @id @default(cuid())
  userId           String?
  sessionId        String?
  email            String?
  items            Json      // Array of {productId, formatId, quantity, price}
  totalValue       Decimal   @default(0) @db.Decimal(10, 2)
  status           String    @default("ABANDONED") // ABANDONED, RECOVERY_SENT, RECOVERED, EXPIRED
  recoveryAttempts Json?     // Array of {sentAt, type, result}
  recoveredAt      DateTime?
  recoveredOrderId String?
  abandonedAt      DateTime  @default(now())
  expiresAt        DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([userId])
  @@index([email])
  @@index([status])
  @@index([abandonedAt])
  @@index([createdAt])
  @@index([updatedAt])
}

// DB-005: Custom fields / metafields system
model CustomField {
  id           String             @id @default(cuid())
  name         String
  key          String             @unique
  description  String?
  fieldType    String             @default("TEXT") // TEXT, NUMBER, BOOLEAN, DATE, SELECT, JSON
  entityType   String             // PRODUCT, ORDER, USER, CATEGORY
  options      Json?              // For SELECT type: array of possible values
  isRequired   Boolean            @default(false)
  sortOrder    Int                @default(0)
  isActive     Boolean            @default(true)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  values       CustomFieldValue[]

  @@index([entityType])
  @@index([key])
  @@index([isActive])
  @@index([createdAt])
  @@index([updatedAt])
}

model CustomFieldValue {
  id            String      @id @default(cuid())
  customFieldId String
  entityId      String
  value         String?
  numberValue   Decimal?    @db.Decimal(12, 4)
  booleanValue  Boolean?
  dateValue     DateTime?
  jsonValue     Json?
  customField   CustomField @relation(fields: [customFieldId], references: [id], onDelete: Cascade)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([customFieldId, entityId])
  @@index([customFieldId])
  @@index([entityId])
  @@index([createdAt])
  @@index([updatedAt])
}

// DB-006: Workflow automation engine
model Workflow {
  id          String        @id @default(cuid())
  name        String
  description String?
  trigger     String        // ORDER_CREATED, ORDER_PAID, CART_ABANDONED, USER_REGISTERED, etc.
  conditions  Json?         // Array of {field, operator, value}
  actions     Json          // Array of {type, params}
  isActive    Boolean       @default(true)
  priority    Int           @default(0)
  lastRunAt   DateTime?
  runCount    Int           @default(0)
  createdBy   String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  runs        WorkflowRun[]

  @@index([trigger])
  @@index([isActive])
  @@index([createdAt])
  @@index([updatedAt])
}

model WorkflowRun {
  id          String         @id @default(cuid())
  workflowId  String
  workflow    Workflow        @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  status      String         @default("RUNNING") // RUNNING, COMPLETED, FAILED, CANCELLED
  triggeredBy String?        // Entity ID that triggered the workflow
  triggerData Json?          // Snapshot of trigger data
  startedAt   DateTime       @default(now())
  completedAt DateTime?
  error       String?
  steps       WorkflowStep[]
  createdAt   DateTime       @default(now())

  @@index([workflowId])
  @@index([status])
  @@index([startedAt])
  @@index([createdAt])
}

model WorkflowStep {
  id          String      @id @default(cuid())
  runId       String
  run         WorkflowRun @relation(fields: [runId], references: [id], onDelete: Cascade)
  stepIndex   Int
  actionType  String      // SEND_EMAIL, UPDATE_STATUS, ADD_TAG, WAIT, CONDITION, etc.
  actionData  Json?
  status      String      @default("PENDING") // PENDING, RUNNING, COMPLETED, FAILED, SKIPPED
  result      Json?
  startedAt   DateTime?
  completedAt DateTime?
  error       String?
  createdAt   DateTime    @default(now())

  @@index([runId])
  @@index([status])
  @@index([createdAt])
}

// DB-007: Email engagement tracking
model EmailEngagement {
  id              String    @id @default(cuid())
  emailLogId      String?
  campaignId      String?
  recipientEmail  String
  recipientUserId String?
  subject         String?
  openedAt        DateTime?
  openCount       Int       @default(0)
  clickedAt       DateTime?
  clickCount      Int       @default(0)
  clickedLinks    Json?     // Array of {url, clickedAt}
  unsubscribedAt  DateTime?
  bouncedAt       DateTime?
  bounceType      String?   // HARD, SOFT
  complainedAt    DateTime?
  deliveredAt     DateTime?
  sentAt          DateTime  @default(now())
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([recipientEmail])
  @@index([recipientUserId])
  @@index([campaignId])
  @@index([sentAt])
  @@index([openedAt])
  @@index([bouncedAt])
  @@index([createdAt])
  @@index([updatedAt])
}

// DB-008: Performance monitoring log
model PerformanceLog {
  id         String   @id @default(cuid())
  route      String
  method     String   @default("GET")
  duration   Int      // milliseconds
  statusCode Int
  userId     String?
  userAgent  String?
  ipAddress  String?
  memoryUsed Int?     // MB
  queryCount Int?     // number of DB queries
  error      String?
  timestamp  DateTime @default(now())

  @@index([route])
  @@index([duration])
  @@index([statusCode])
  @@index([timestamp])
  @@index([route, timestamp])
}

// DB-010: Cash flow tracking
model CashFlowEntry {
  id          String   @id @default(cuid())
  type        String   // INFLOW, OUTFLOW
  category    String   // SALES, REFUND, SUBSCRIPTION, PAYROLL, SUPPLIER, TAX, etc.
  amount      Decimal  @db.Decimal(12, 2)
  currency    String   @default("CAD")
  description String?
  reference   String?  // Order ID, invoice number, etc.
  date        DateTime
  isProjected Boolean  @default(false) // true = forecast, false = actual
  recurring   Boolean  @default(false)
  recurFreq   String?  // DAILY, WEEKLY, MONTHLY, QUARTERLY, YEARLY
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type])
  @@index([category])
  @@index([date])
  @@index([isProjected])
  @@index([type, date])
  @@index([createdAt])
  @@index([updatedAt])
}

// DB-013: Social proof events for real-time notifications
model SocialProofEvent {
  id           String   @id @default(cuid())
  type         String   // PURCHASE, REVIEW, SIGNUP, WISHLIST
  productId    String?
  productName  String?
  customerCity String?
  customerName String?  // Anonymized: "Marie L."
  metadata     Json?    // Extra context
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  @@index([type])
  @@index([productId])
  @@index([expiresAt])
  @@index([createdAt])
}

// DB-014: Customer preferences from quizzes, interests, communication
model CustomerPreference {
  id                 String   @id @default(cuid())
  userId             String   @unique
  quizAnswers        Json?    // Structured quiz responses
  interests          Json?    // Array of interest tags
  communicationPrefs Json?    // {email: true, sms: false, push: true}
  preferredLanguage  String?
  preferredCurrency  String?
  skinType           String?  // For peptide recommendations
  goals              Json?    // Array of health/wellness goals
  allergies          Json?    // Array of known allergies
  completedAt        DateTime?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([userId])
  @@index([createdAt])
  @@index([updatedAt])
}

// =============================================
// F-005 (Communauté CRITICAL): Forum community backend
// =============================================

model ForumCategory {
  id          String      @id @default(cuid())
  name        String
  slug        String      @unique
  description String?
  icon        String?
  sortOrder   Int         @default(0)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  posts       ForumPost[]

  @@index([slug])
  @@index([sortOrder])
}

model ForumPost {
  id           String         @id @default(cuid())
  title        String
  content      String
  authorId     String
  categoryId   String
  upvotes      Int            @default(0)
  downvotes    Int            @default(0)
  viewCount    Int            @default(0)
  isPinned     Boolean        @default(false)
  isLocked     Boolean        @default(false)
  deletedAt    DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  author       User           @relation("ForumPostAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  category     ForumCategory  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  replies      ForumReply[]
  votes        ForumVote[]    @relation("PostVotes")

  @@index([authorId])
  @@index([categoryId])
  @@index([createdAt])
  @@index([isPinned, createdAt])
  @@index([deletedAt])
}

model ForumReply {
  id            String       @id @default(cuid())
  content       String
  authorId      String
  postId        String
  parentReplyId String?
  upvotes       Int          @default(0)
  downvotes     Int          @default(0)
  deletedAt     DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  author        User         @relation("ForumReplyAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  post          ForumPost    @relation(fields: [postId], references: [id], onDelete: Cascade)
  parentReply   ForumReply?  @relation("ReplyToReply", fields: [parentReplyId], references: [id])
  childReplies  ForumReply[] @relation("ReplyToReply")
  votes         ForumVote[]  @relation("ReplyVotes")

  @@index([postId])
  @@index([authorId])
  @@index([parentReplyId])
  @@index([createdAt])
  @@index([deletedAt])
}

model ForumVote {
  id        String      @id @default(cuid())
  userId    String
  postId    String?
  replyId   String?
  value     Int         // +1 or -1
  createdAt DateTime    @default(now())
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      ForumPost?  @relation("PostVotes", fields: [postId], references: [id], onDelete: Cascade)
  reply     ForumReply? @relation("ReplyVotes", fields: [replyId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@unique([userId, replyId])
  @@index([postId])
  @@index([replyId])
}

// =============================================
// F-100 (Communauté): Contact form persistence
// =============================================

model ContactMessage {
  id        String    @id @default(cuid())
  name      String
  email     String
  subject   String?
  message   String
  userId    String?
  ipAddress String?
  isRead    Boolean   @default(false)
  readAt    DateTime?
  createdAt DateTime  @default(now())
  user      User?     @relation("ContactMessageUser", fields: [userId], references: [id], onDelete: SetNull)

  @@index([email])
  @@index([createdAt])
  @@index([isRead])
}
